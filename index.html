<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de OcorrÃªncias - 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,#9fe7ff 0%, #b9f7c9 60%, #baf3ff 100%);
      color:#fff; font-weight:800; padding:18px;
    }
    .app{max-width:1400px;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px;border-radius:14px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    header h1{font-size:20px;margin:0}
    .header-controls{display:flex;gap:10px;align-items:center}
    .card{background:#2f3336;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    .flex{display:flex;gap:18px;align-items:flex-start}
    .col{display:flex;flex-direction:column;gap:12px}
    label{display:block;margin-bottom:6px;font-size:13px}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      min-width: 120px; padding:10px 12px;border-radius:8px;border:none;font-weight:800;font-size:14px;color:#111;
      width: auto; max-width: 100%;
    }
    .date-field-container { position: relative; display: flex; align-items: center; }
    .date-field-container input[type="date"] { flex: 1; }
    .date-field-container::after { content: "ðŸ“…"; position: absolute; right: 12px; pointer-events: none; }
    textarea{min-height:110px;resize:vertical;padding-top:12px; width: 100%;}
    button{cursor:pointer;border:none;padding:10px 14px;border-radius:8px;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,0.15)}
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff}
    .subtitle{font-size:14px;color:#d9f2ff;margin-bottom:6px}
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:6px}
    .historyItem{background:rgba(255,255,255,0.06);border-left:5px solid rgba(255,255,255,0.06);padding:12px;border-radius:8px;color:#fff;font-weight:700}
    .historyItem .meta{font-size:13px;color:#dbefff;font-weight:800;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .historyItem .desc{margin-top:8px;color:#e7f7ff;font-weight:600;font-size:14px}
    .form-row {display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start;}
    .form-group {display: flex; flex-direction:column; flex: 1 1 auto;}
    .form-group label {margin-bottom: 6px;}
    .gestao-form .form-group {flex: 1;}
    .gestao-form .form-row {margin-bottom: 15px;}
    .gestao-form input, .gestao-form select, .gestao-form textarea { width: auto; min-width: 150px; padding: 12px; font-size: 15px; }
    .gestao-form .form-row.double { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .gestao-form .form-row.triple { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .gestao-form .form-row.full { display: block; }
    .checkbox-group {display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;}
    .checkbox-item {background: #efefef; color: #111; padding: 6px 10px; border-radius: 999px; display: inline-flex; align-items: center;}
    .checkbox-item input {margin-right: 4px;}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:2000}
    .modal{width:92%;max-width:780px;background:#fff;color:#111;border-radius:12px;padding:14px;max-height:84vh;overflow:auto}
    .studentList{display:flex;flex-direction:column;gap:8px}
    .student-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid #ddd;border-radius:8px;cursor:pointer}
    .student-row.selected{background:#e9f3ff}
    .student-name{font-weight:800}
    .pill{background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 10px;border-radius:999px;font-weight:800;display:inline-block}
    .muted{opacity:.9;font-weight:700;color:#e7f7ff}
    .notification {
      position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 700; z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease;
    }
    .notification.success { background: linear-gradient(90deg, #4CAF50, #2E7D32); }
    .notification.error { background: linear-gradient(90deg, #e94b4b, #c62828); }

    @media(max-width:980px){
      .flex{flex-direction:column}
      header{flex-direction:column;gap:8px;align-items:flex-start} 
      .form-row {flex-direction: column;}
      .gestao-form .form-row {flex-direction: column;}
      .gestao-form .form-row.double, .gestao-form .form-row.triple { grid-template-columns: 1fr; }
      input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"] { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">

    <header>
      <h1>2025 â€” Cadastro de OcorrÃªncias</h1>
      <div class="header-controls">
        <div id="userDisplay" class="muted">NÃ£o autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen" class="card" style="display:block">
      <div style="max-width: 480px; margin: 0 auto;">
        <div class="subtitle">Acesso ao Sistema</div>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label for="emailLogin">E-mail</label>
            <input id="emailLogin" type="email" placeholder="seu.email@escola.com">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label for="passwordLogin">Senha</label>
            <input id="passwordLogin" type="password" placeholder="senha">
          </div>
        </div>
        <div class="form-row">
          <button class="btn-primary" onclick="login()">Entrar</button>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GESTÃƒO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <div class="card col" style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <div style="font-size:18px;font-weight:800">CADASTRO â€” GESTÃƒO</div>
          </div>

          <div class="col gestao-form">
            <div class="form-row double">
              <div class="form-group">
                <label>SÃ©rie / Turma</label>
                <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                  <option value="">-- Selecione a turma --</option>
                </select>
              </div>
              <div class="form-group">
                <label>Aluno</label>
                <select id="aluno_gestao" onchange="preencherRAGestao()">
                  <option value="">-- Selecione o aluno --</option>
                </select>
              </div>
            </div>

            <div class="form-row triple">
              <div class="form-group">
                <label>RA</label>
                <input id="ra_gestao" type="text" readonly>
              </div>
              <div class="form-group">
                <label>Professor</label>
                <input id="professor_gestao" type="text">
              </div>
              <div class="form-group">
                <label>Disciplina</label>
                <input id="disciplina_gestao" type="text">
              </div>
            </div>

            <div class="form-row double">
              <div class="form-group">
                <label>ClassificaÃ§Ã£o</label>
                <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                  <option value="">Selecione</option>
                  <option value="OCORRÃŠNCIA">OCORRÃŠNCIA</option>
                  <option value="SUSPENSÃƒO">SUSPENSÃƒO</option>
                </select>
              </div>
              <div class="form-group" style="display:none" id="suspensionRow_gestao">
                <label>Data de retorno</label>
                <div class="date-field-container">
                  <input id="dataRetorno_gestao" type="date">
                </div>
              </div>
            </div>

            <div class="form-row full">
              <div class="form-group">
                <label>DescriÃ§Ã£o</label>
                <textarea id="descricao_gestao" placeholder="DescriÃ§Ã£o detalhada"></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (GestÃ£o)</button>
              <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="subtitle">HISTÃ“RICO DE OCORRÃŠNCIAS - GESTÃƒO</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button>
          </div>
        </div>
        <div style="margin-top:12px" id="historyListGestao" class="historyList"></div>
      </div>
    </div>

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <div class="card col" style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <div style="font-size:18px;font-weight:800">REGISTRO â€” PROFESSOR</div>
          </div>

          <div class="col">
            <div class="form-row double">
              <div class="form-group">
                <label>Professor</label>
                <select id="professor_select"></select>
              </div>
              <div class="form-group">
                <label>Turma</label>
                <select id="turma_select" onchange="onTurmaChange()"></select>
              </div>
            </div>

            <div class="form-row double">
              <div class="form-group">
                <label>Alunos (clique para selecionar)</label>
                <input id="alunos_selected_input" type="text" readonly placeholder="Clique para selecionar" onclick="openStudentsModal()">
                <div id="selectedPills" style="margin-top:8px"></div>
              </div>
              <div class="form-group">
                <label>Data</label>
                <div class="date-field-container">
                  <input id="data_prof" type="date">
                </div>
              </div>
            </div>

            <div class="form-row full">
              <div class="form-group">
                <label>Irregularidades</label>
                <div class="checkbox-group">
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="AgressÃ£o"> AgressÃ£o</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Danos ao patrimÃ´nio"> Danos ao patrimÃ´nio</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Desacato"> Desacato</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Falta de material"> Falta de material</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="NÃ£o realiza as atividades"> NÃ£o realiza as atividades</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Saiu da sala sem autorizaÃ§Ã£o"> Saiu da sala sem autorizaÃ§Ã£o</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular</label>
                </div>
              </div>
            </div>

            <div class="form-row full">
              <div class="form-group">
                <label>DescriÃ§Ã£o</label>
                <textarea id="descricao_prof" placeholder="Descreva a ocorrÃªncia..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
              <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="flex">
        <div class="card" style="flex: 1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="subtitle">HISTÃ“RICO DE OCORRÃŠNCIAS - PROFESSOR</div>
            <button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button>
          </div>
          <div style="margin-top:12px" id="historyListProfessor" class="historyList"></div>
        </div>
      </div>
    </div>

    <!-- MODAL SELEÃ‡ÃƒO ALUNOS -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #eee">
          <strong>Selecionar alunos</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-weight:900;cursor:pointer">âœ•</button>
        </div>
        <div style="max-height:60vh;overflow-y:auto;margin-bottom:15px">
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px" oninput="filterStudentList()">
          <div id="studentList" class="studentList"></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;padding-top:15px;border-top:1px solid #eee">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    /*******************************
     * CONFIGURAÃ‡Ã•ES
     *******************************/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzmmc0i28l-Oqmn9Tp2dnUqR35KpvVLRf3uezzKlCiQFQHDdm4hSz32hkYwOY8olg8n/exec';
    // ðŸ‘† TROQUE pela URL do seu WebApp (/exec)

    const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES';
    const SHEET_GESTAO = 'BANCODEALUNOS';

    // estado
    let alunosDaTurmaAtual = [];
    let alunosSelecionados = [];
    let professores = [];
    let turmas = [];
    let currentUserRole = null;
    let alunosComRA = [];

    /*******************************
     * HELPERS
     *******************************/
    function showNotification(type, message) {
      const existing = document.querySelectorAll('.notification');
      existing.forEach(n => n.remove());

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => notification.remove(), 5000);
    }

    function getToken(){ return localStorage.getItem('userToken') || ''; }

    function buildApiUrl(endpoint, params = {}) {
      const url = new URL(SCRIPT_URL);
      url.searchParams.set('endpoint', endpoint);

      const token = getToken();
      if (token) url.searchParams.set('token', token);

      Object.entries(params).forEach(([k,v]) => {
        if (v !== undefined && v !== null && String(v) !== '') url.searchParams.set(k, v);
      });

      return url.toString();
    }

    async function apiGet(endpoint, params = {}) {
      const resp = await fetch(buildApiUrl(endpoint, params), { method: 'GET' });
      return await resp.json();
    }

    // POST como x-www-form-urlencoded para reduzir CORS/preflight
    async function apiPost(endpoint, body = {}) {
      const token = getToken();
      const payload = { endpoint, ...body };
      if (token) payload.token = token;

      const form = new URLSearchParams();
      Object.entries(payload).forEach(([k,v]) => form.append(k, v ?? ''));

      const resp = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: form
      });

      return await resp.json();
    }

    function pick(obj, keys) {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '') return obj[k];
      }
      return '';
    }

    function formatDateBr(value, withTime = true) {
      if (!value) return '';
      const d = new Date(value);
      if (isNaN(d.getTime())) return String(value);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      if (!withTime) return `${dd}/${mm}/${yyyy}`;
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`;
    }

    function extractIrregAndCleanDesc(descRaw) {
      const s = String(descRaw || '');
      // padrÃ£o: "[IRREG] descriÃ§Ã£o..."
      const m = s.match(/^\s*\[([^\]]+)\]\s*(.*)$/);
      if (m) return { irreg: m[1].trim(), desc: (m[2] || '').trim() };
      return { irreg: '', desc: s };
    }

    /*******************************
     * INIT
     *******************************/
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];

      const token = localStorage.getItem('userToken');
      const email = localStorage.getItem('userEmail');
      const role  = localStorage.getItem('userRole');
      if (token && email && role) {
        showAppAs(role, email);
      }
    });

    /*******************************
     * LOGIN / LOGOUT
     *******************************/
    async function login(){
      const email = document.getElementById('emailLogin').value.trim();
      const password = document.getElementById('passwordLogin').value.trim();

      if(!email || !password){
        showNotification('error', 'Preencha e-mail e senha.');
        return;
      }

      try {
        const j = await apiPost('login', { email, password });

        if(j && j.status === 'success'){
          localStorage.setItem('userToken', j.token);
          localStorage.setItem('userEmail', email);
          localStorage.setItem('userRole', j.role);

          showAppAs(j.role, email);
          showNotification('success', 'Login realizado com sucesso!');
        } else {
          showNotification('error', j.message || 'Erro de login.');
        }
      } catch(err){
        console.error('Erro login:', err);
        showNotification('error', 'Falha na comunicaÃ§Ã£o com servidor');
      }
    }

    function showAppAs(role, email){
      currentUserRole = role;

      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('btnLogout').style.display = 'inline-block';
      document.getElementById('userDisplay').textContent = email + (role==='gestao'?' (GestÃ£o)':' (Professor)');

      if (role === 'gestao') {
        document.getElementById('mainAppGestao').style.display = 'flex';
        document.getElementById('mainAppProfessor').style.display = 'none';
        carregarTurmasGestao();
        carregarHistoricoGestao();
      } else {
        document.getElementById('mainAppGestao').style.display = 'none';
        document.getElementById('mainAppProfessor').style.display = 'flex';
        carregarProfessoresETurmas();
        carregarHistoricoProfessor();
      }
    }

    function logout(){
      currentUserRole = null;

      localStorage.removeItem('userToken');
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userRole');

      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainAppGestao').style.display = 'none';
      document.getElementById('mainAppProfessor').style.display = 'none';
      document.getElementById('userDisplay').textContent = 'NÃ£o autenticado';
      document.getElementById('btnLogout').style.display = 'none';

      alunosDaTurmaAtual = [];
      alunosSelecionados = [];
      document.getElementById('selectedPills').innerHTML = '';
      document.getElementById('emailLogin').value = '';
      document.getElementById('passwordLogin').value = '';
    }

    /*******************************
     * GESTÃƒO
     *******************************/
    async function carregarTurmasGestao() {
      try {
        const j = await apiGet('classes');
        turmas = (j && j.status === 'success' && Array.isArray(j.classes)) ? j.classes : Object.keys(_getClassRanges());

        const turmaSelect = document.getElementById('serie_gestao');
        turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t;
          turmaSelect.appendChild(option);
        });
      } catch(err) {
        console.error('Erro ao carregar turmas (gestÃ£o):', err);
        turmas = Object.keys(_getClassRanges());
        const turmaSelect = document.getElementById('serie_gestao');
        turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t;
          turmaSelect.appendChild(option);
        });
      }
    }

    async function carregarAlunosPorTurmaGestao(turma) {
      if (!turma) {
        document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
        document.getElementById('ra_gestao').value = '';
        return;
      }

      try {
        const alunoSelect = document.getElementById('aluno_gestao');
        alunoSelect.innerHTML = '<option value="">Carregando alunos...</option>';

        const json = await apiGet('students', { turma });

        if (json.status === 'success') {
          alunosComRA = (json.studentsWithRa || json.studentsList || []);
          alunoSelect.innerHTML = '<option value="">-- Selecione o aluno --</option>';

          if (alunosComRA.length > 0) {
            alunosComRA.forEach(aluno => {
              const option = document.createElement('option');
              option.value = aluno.nome;
              option.textContent = aluno.nome;
              option.setAttribute('data-ra', aluno.ra || '');
              alunoSelect.appendChild(option);
            });
          } else {
            alunoSelect.innerHTML = '<option value="">Nenhum aluno encontrado</option>';
            showNotification('error', 'Nenhum aluno encontrado para esta turma');
          }
        } else {
          alunoSelect.innerHTML = '<option value="">Erro ao carregar</option>';
          showNotification('error', json.message || 'Erro ao carregar alunos');
        }
      } catch(err) {
        console.error('Erro ao carregar alunos (gestÃ£o):', err);
        document.getElementById('aluno_gestao').innerHTML = '<option value="">Erro ao carregar</option>';
        showNotification('error', 'Erro de conexÃ£o ao carregar alunos');
      }
    }

    function preencherRAGestao() {
      const alunoSelect = document.getElementById('aluno_gestao');
      const selectedOption = alunoSelect.options[alunoSelect.selectedIndex];
      if (selectedOption && selectedOption.value) {
        const ra = selectedOption.getAttribute('data-ra') || '';
        document.getElementById('ra_gestao').value = ra;
      } else {
        document.getElementById('ra_gestao').value = '';
      }
    }

    async function cadastrarOcorrenciaGestao(){
      const aluno = document.getElementById('aluno_gestao').value;
      const turma = document.getElementById('serie_gestao').value;
      const professor = document.getElementById('professor_gestao').value.trim();
      const disciplina = document.getElementById('disciplina_gestao').value.trim();
      const classificacao = document.getElementById('classificacao_gestao').value;
      const descricao = document.getElementById('descricao_gestao').value.trim();
      const dataRetorno = document.getElementById('dataRetorno_gestao').value || '';
      const ra = document.getElementById('ra_gestao').value || '';

      if(!aluno || !turma || !professor || !disciplina || !classificacao || !descricao){ 
        showNotification('error', 'Preencha todos os campos obrigatÃ³rios.');
        return; 
      }
      if(classificacao === 'SUSPENSÃƒO' && !dataRetorno){ 
        showNotification('error', 'Informe data de retorno para suspensÃ£o.');
        return; 
      }

      try {
        const j = await apiPost('create-occurrence', {
          role: 'gestao',
          professor,
          turma,
          aluno,
          ra,
          disciplina,
          irregularidades: classificacao,
          descricao,
          dataRetorno
        });

        if(j && j.status === 'success'){
          showNotification('success', 'OcorrÃªncia registrada com sucesso!');

          document.getElementById('serie_gestao').value = '';
          document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
          document.getElementById('ra_gestao').value = '';
          document.getElementById('professor_gestao').value = '';
          document.getElementById('disciplina_gestao').value = '';
          document.getElementById('classificacao_gestao').value = '';
          document.getElementById('descricao_gestao').value = '';
          document.getElementById('dataRetorno_gestao').value = '';
          document.getElementById('suspensionRow_gestao').style.display = 'none';

          setTimeout(() => carregarHistoricoGestao(), 800);
        } else {
          showNotification('error', j.message || 'Erro ao registrar ocorrÃªncia!');
        }
      } catch(err){
        console.error('Erro POST ocorrencia (gestao):', err);
        showNotification('error', 'Falha na comunicaÃ§Ã£o com servidor');
      }
    }

    function toggleSuspension(area){
      if(area === 'gestao'){ 
        const val = document.getElementById('classificacao_gestao').value; 
        document.getElementById('suspensionRow_gestao').style.display = (val === 'SUSPENSÃƒO') ? 'flex' : 'none'; 
      }
    }

    async function carregarHistoricoGestao(){
      const container = document.getElementById('historyListGestao');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px">Carregando histÃ³rico...</div>`;

      try {
        const json = await apiGet('occurrences', { sheet: SHEET_GESTAO });
        const ocorrs = json.occurrences || [];

        container.innerHTML = '';
        if(!ocorrs.length){
          container.innerHTML = '<div class="muted">Nenhuma ocorrÃªncia encontrada.</div>';
          return;
        }

        ocorrs.slice().reverse().forEach(r => {
          const dateRaw = pick(r, ['DATA DO REGISTRO/HORA', 'DATA', 'Data']);
          const prof = pick(r, ['PROFESSOR']);
          const turma = pick(r, ['SÃ‰RIE', 'SERIE', 'TURMA']);
          const aluno = pick(r, ['NOME', 'ALUNO']);
          const ra = pick(r, ['RA']);
          const disciplina = pick(r, ['DISCIPLINA']);
          const descRaw = pick(r, ['DESCRIÃ‡ÃƒO', 'DESCRICAO']);
          const urlDoc = pick(r, ['URL DO DOCUMENTO', 'URL DO DOCUMENTO ', 'URL']);
          const retorno = pick(r, ['DATA DE RETORNO']);

          // tenta extrair irregularidade da descriÃ§Ã£o caso tenha sido prefixada
          const { irreg, desc } = extractIrregAndCleanDesc(descRaw);

          const div = document.createElement('div');
          div.className='historyItem';

          const meta = document.createElement('div');
          meta.className='meta';
          meta.innerHTML = `<div><strong>${formatDateBr(dateRaw,true)}</strong> â€” <span class="muted">${prof || '-'}</span></div>`;

          const ddesc = document.createElement('div');
          ddesc.className='desc';

          let docLine = '';
          if (urlDoc) {
            docLine = `<br/><strong>Documento:</strong> <a href="${urlDoc}" target="_blank" style="color:#bfe7ff;text-decoration:underline">abrir</a>`;
          }

          let retornoLine = '';
          if (retorno) {
            retornoLine = `<br/><strong>Data de retorno:</strong> ${formatDateBr(retorno,false)}`;
          }

          ddesc.innerHTML = `
            <strong>Aluno:</strong> ${aluno || 'N/A'}<br/>
            <strong>Turma:</strong> ${turma || 'N/A'}<br/>
            <strong>RA:</strong> ${ra || 'N/A'}<br/>
            <strong>Disciplina:</strong> ${disciplina || 'N/A'}<br/>
            <strong>ClassificaÃ§Ã£o/Irregularidades:</strong> ${irreg || 'N/A'}<br/>
            <em>${desc || ''}</em>
            ${retornoLine}
            ${docLine}
          `;

          div.appendChild(meta);
          div.appendChild(ddesc);
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistoricoGestao:', err);
        container.innerHTML = '<div class="muted">Erro ao carregar histÃ³rico</div>';
      }
    }

    /*******************************
     * PROFESSOR
     *******************************/
    async function carregarProfessoresETurmas(){
      try {
        const j1 = await apiGet('teachers');
        professores = (j1 && j1.status === 'success' && Array.isArray(j1.teachers)) ? j1.teachers : getFallbackProfessores();

        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => {
          const o = document.createElement('option');
          o.value = p;
          o.textContent = p;
          profSel.appendChild(o);
        });

        const j2 = await apiGet('classes');
        turmas = (j2 && j2.status === 'success' && Array.isArray(j2.classes)) ? j2.classes : Object.keys(_getClassRanges());

        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => {
          const o = document.createElement('option');
          o.value = t;
          o.textContent = t;
          turmaSel.appendChild(o);
        });
      } catch(err){
        console.error('Erro carregar professores/turmas:', err);
        professores = getFallbackProfessores();
        turmas = Object.keys(_getClassRanges());

        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => {
          const o = document.createElement('option');
          o.value = p;
          o.textContent = p;
          profSel.appendChild(o);
        });

        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => {
          const o = document.createElement('option');
          o.value = t;
          o.textContent = t;
          turmaSel.appendChild(o);
        });
      }
    }

    async function onTurmaChange(){
      const turma = document.getElementById('turma_select').value;
      if(!turma){ alunosDaTurmaAtual = []; return; }
      await carregarAlunosPorTurma(turma);
    }

    async function carregarAlunosPorTurma(turma){
      try {
        const json = await apiGet('students', { turma });
        if (json.status === 'success') {
          alunosDaTurmaAtual = json.students || [];
        } else {
          alunosDaTurmaAtual = [];
          showNotification('error', `Erro ao carregar alunos: ${json.message}`);
        }
      } catch(err){
        console.error('Erro get students:', err);
        alunosDaTurmaAtual = [];
        showNotification('error', 'Erro de conexÃ£o ao carregar alunos');
      }
    }

    function openStudentsModal(){
      if(!alunosDaTurmaAtual || alunosDaTurmaAtual.length === 0){
        showNotification('error', 'Nenhum aluno encontrado para a turma selecionada.');
        return;
      }
      document.getElementById('modalRoot').style.display = 'flex';
      renderStudentList(alunosDaTurmaAtual);
      document.getElementById('studentSearch').value = '';
    }

    function closeStudentsModal(){
      document.getElementById('modalRoot').style.display = 'none';
    }

    function renderStudentList(list){
      const container = document.getElementById('studentList');
      container.innerHTML = '';

      list.forEach(nome => {
        const row = document.createElement('div');
        row.className = 'student-row';
        if (alunosSelecionados.includes(nome)) row.classList.add('selected');

        const lbl = document.createElement('div');
        lbl.className = 'student-name';
        lbl.textContent = nome;

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = nome;
        cb.checked = alunosSelecionados.includes(nome);

        cb.onchange = (e) => {
          toggleStudentSelection(nome, e.target.checked);
          updateStudentRowStyle(row, nome);
        };

        row.onclick = (e) => {
          if (e.target !== cb) {
            const newState = !alunosSelecionados.includes(nome);
            cb.checked = newState;
            toggleStudentSelection(nome, newState);
            updateStudentRowStyle(row, nome);
          }
        };

        row.appendChild(lbl);
        row.appendChild(cb);
        container.appendChild(row);
      });
    }

    function toggleStudentSelection(nome, isSelected) {
      if(isSelected){
        if(!alunosSelecionados.includes(nome)) alunosSelecionados.push(nome);
      } else {
        alunosSelecionados = alunosSelecionados.filter(x => x !== nome);
      }
    }

    function updateStudentRowStyle(row, nome) {
      if (alunosSelecionados.includes(nome)) row.classList.add('selected');
      else row.classList.remove('selected');
    }

    function filterStudentList(){
      const q = document.getElementById('studentSearch').value.toLowerCase();
      const filtered = alunosDaTurmaAtual.filter(s => s.toLowerCase().includes(q));
      renderStudentList(filtered);
    }

    function confirmStudents(){
      document.getElementById('alunos_selected_input').value = alunosSelecionados.join(', ');
      const pills = document.getElementById('selectedPills');
      pills.innerHTML = '';
      alunosSelecionados.forEach(a => {
        const el = document.createElement('div');
        el.className='pill';
        el.textContent = a;
        pills.appendChild(el);
      });
      closeStudentsModal();
    }

    async function registrarOcorrenciaProfessor(){
      const professor = document.getElementById('professor_select').value;
      const turma = document.getElementById('turma_select').value;
      const dataOc = document.getElementById('data_prof').value;
      const descricao = document.getElementById('descricao_prof').value.trim();

      if(!professor || !turma || !dataOc || alunosSelecionados.length === 0 || !descricao){
        showNotification('error', 'Preencha todos os campos obrigatÃ³rios, selecione aluno(s) e escreva a descriÃ§Ã£o.');
        return;
      }

      const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x=>x.value);
      if(irregs.length === 0){
        showNotification('error', 'Selecione ao menos uma irregularidade.');
        return;
      }

      try {
        const j = await apiPost('create-occurrence', {
          role: 'professor',
          professor,
          turma,
          aluno: alunosSelecionados.join(', '),
          irregularidades: irregs.join(', '),
          descricao,
          date: dataOc
        });

        if(j && j.status === 'success'){
          showNotification('success', 'OcorrÃªncia registrada com sucesso!');
          clearProfessorForm();
          setTimeout(() => carregarHistoricoProfessor(), 800);
        } else {
          showNotification('error', j.message || 'Erro ao registrar ocorrÃªncia!');
        }
      } catch(err){
        console.error('Erro POST ocorrencia (professor):', err);
        showNotification('error', 'Falha na comunicaÃ§Ã£o com servidor');
      }
    }

    function clearProfessorForm(){
      document.getElementById('professor_select').value = '';
      document.getElementById('turma_select').value = '';
      document.getElementById('alunos_selected_input').value = '';
      document.getElementById('selectedPills').innerHTML = '';
      document.getElementById('descricao_prof').value = '';
      alunosSelecionados = [];
      Array.from(document.querySelectorAll('input[name="irreg"]')).forEach(cb => cb.checked = false);
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
    }

    async function carregarHistoricoProfessor(){
      const container = document.getElementById('historyListProfessor');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px">Carregando histÃ³rico...</div>`;

      try {
        const json = await apiGet('occurrences', { sheet: SHEET_PROF });
        const ocorrs = json.occurrences || [];

        container.innerHTML = '';
        if(!ocorrs.length){
          container.innerHTML = '<div class="muted">Nenhuma ocorrÃªncia encontrada.</div>';
          return;
        }

        ocorrs.slice().reverse().forEach(r => {
          const dateRaw = pick(r, ['DATA', 'Data']);
          const prof = pick(r, ['PROFESSOR']);
          const turma = pick(r, ['TURMA']);
          const aluno = pick(r, ['ALUNO']);
          const irreg = pick(r, ['IRREGULARIDADES']);
          const desc = pick(r, ['DESCRICAO', 'DESCRIÃ‡ÃƒO']);
          const ra = pick(r, ['RA']);
          const disciplina = pick(r, ['DISCIPLINA']);

          const div = document.createElement('div');
          div.className='historyItem';

          const meta = document.createElement('div');
          meta.className='meta';
          meta.innerHTML = `<div><strong>${formatDateBr(dateRaw,true)}</strong> â€” <span class="muted">${prof || '-'}</span></div>`;

          const ddesc = document.createElement('div');
          ddesc.className='desc';
          ddesc.innerHTML = `
            <strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/>
            <strong>Turma:</strong> ${turma || 'N/A'}<br/>
            <strong>RA:</strong> ${ra || 'N/A'}<br/>
            <strong>Disciplina:</strong> ${disciplina || 'N/A'}<br/>
            <strong>Irregularidades:</strong> ${irreg || 'N/A'}<br/>
            <em>${desc || ''}</em>
          `;

          div.appendChild(meta);
          div.appendChild(ddesc);
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistoricoProfessor:', err);
        container.innerHTML = '<div class="muted">Erro ao carregar histÃ³rico</div>';
      }
    }

    /*******************************
     * PDF local
     *******************************/
    function generatePDFLocal(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Registro de OcorrÃªncia', 14, 20);

        const aluno = document.getElementById('aluno_gestao').value || '';
        const turma = document.getElementById('serie_gestao').value || '';
        const prof = document.getElementById('professor_gestao').value || '';
        const desc = document.getElementById('descricao_gestao').value || '';

        let y = 36;
        if(aluno){ doc.text(`Aluno: ${aluno}`, 14, y); y+=8; }
        if(turma){ doc.text(`Turma: ${turma}`, 14, y); y+=8; }
        if(prof){ doc.text(`Professor: ${prof}`, 14, y); y+=8; }

        doc.text('DescriÃ§Ã£o:', 14, y); y+=8;
        const split = doc.splitTextToSize(desc || 'Sem descriÃ§Ã£o', 180);
        doc.text(split, 14, y);

        doc.save(`ocorrencia_${Date.now()}.pdf`);
      } catch(err){
        console.error('Erro gerar PDF local:', err);
        showNotification('error', 'Erro ao gerar PDF local');
      }
    }

    /*******************************
     * FALLBACKS
     *******************************/
    function _getClassRanges() {
      // fallback de nomes (caso a API "classes" falhe)
      return {
        "6Âº ANO A":"6Âº ANO A","6Âº ANO B":"6Âº ANO B","6Âº ANO C":"6Âº ANO C","6Âº ANO D":"6Âº ANO D","6Âº ANO E":"6Âº ANO E","6Âº ANO F":"6Âº ANO F",
        "7Âº ANO A":"7Âº ANO A","7Âº ANO B":"7Âº ANO B","7Âº ANO C":"7Âº ANO C","7Âº ANO D":"7Âº ANO D","7Âº ANO E":"7Âº ANO E","7Âº ANO F":"7Âº ANO F",
        "8Âº ANO A":"8Âº ANO A","8Âº ANO B":"8Âº ANO B","8Âº ANO C":"8Âº ANO C","8Âº ANO D":"8Âº ANO D","8Âº ANO E":"8Âº ANO E",
        "9Âº ANO A":"9Âº ANO A","9Âº ANO B":"9Âº ANO B","9Âº ANO C":"9Âº ANO C","9Âº ANO D":"9Âº ANO D",
        "1Âª SÃ‰RIE A":"1Âª SÃ‰RIE A","1Âª SÃ‰RIE B":"1Âª SÃ‰RIE B","1Âª SÃ‰RIE C":"1Âª SÃ‰RIE C","1Âª SÃ‰RIE D":"1Âª SÃ‰RIE D","1Âª SÃ‰RIE E":"1Âª SÃ‰RIE E","1Âª SÃ‰RIE F":"1Âª SÃ‰RIE F","1Âª SÃ‰RIE G":"1Âª SÃ‰RIE G","1Âª SÃ‰RIE H":"1Âª SÃ‰RIE H","1Âª SÃ‰RIE I":"1Âª SÃ‰RIE I",
        "2Âª SÃ‰RIE A":"2Âª SÃ‰RIE A","2Âª SÃ‰RIE B":"2Âª SÃ‰RIE B","2Âª SÃ‰RIE C":"2Âª SÃ‰RIE C","2Âª SÃ‰RIE D":"2Âª SÃ‰RIE D","2Âª SÃ‰RIE E":"2Âª SÃ‰RIE E","2Âª SÃ‰RIE F":"2Âª SÃ‰RIE F","2Âª SÃ‰RIE G":"2Âª SÃ‰RIE G","2Âª SÃ‰RIE H":"2Âª SÃ‰RIE H",
        "3Âª SÃ‰RIE A":"3Âª SÃ‰RIE A","3Âª SÃ‰RIE B":"3Âª SÃ‰RIE B","3Âª SÃ‰RIE C":"3Âª SÃ‰RIE C","3Âª SÃ‰RIE D":"3Âª SÃ‰RIE D","3Âª SÃ‰RIE E":"3Âª SÃ‰RIE E","3Âª SÃ‰RIE F":"3Âª SÃ‰RIE F","3Âª SÃ‰RIE G":"3Âª SÃ‰RIE G"
      };
    }

    function getFallbackProfessores(){
      return [
        "ALEX LUTH PEREIRA MARANHAO","ALEXSANDRA PAULA VARELLA DE SOUZA","ALISON VASCONCELOS BESERRA","AMAURI TEODORO DE OLIVEIRA",
        "ANA PAULA DOS SANTOS","ANDREIA DOS SANTOS FREITAS","ANDREIA MADUREIRA REIS","ANTONIO CARLOS DE OLIVEIRA",
        "ANTONIO RAMS DE ARAUJO","ANTONIO WILTON WANDERLEY CABRAL","AUGUSTO LINO PESSOA NETO","AUREA MARIA DE JESUS MARQUES",
        "CAROLINA PERNOMIAN PARUSSOLOLO","CASSIA OLIVEIRA ANTONIAZI","CLAUDINEIA DE AGUIAR LIMA","DANIEL DE FREITAS ALMEIDA",
        "DANIEL LOPES BARBOSA","DANIELA FERREIRA LIMA","DANIELLE LUCIA BATISTA DE ALMEIDA","EDIANE VIEIRA DA SILVA",
        "EDILEUSA NUNES PEREIRA","EDUARDO HENRIQUE DA FONSECA","ELIANE SANTOS SILVA","ELIAS MONTEIRO DA SILVERA",
        "ELISABETE APARECIDA PIRES","ELZA DE FARIA PEREIRA","EMERSON GABLER DE ALMEIDA","EUZELI ARAUJO DE OLIVEIRA",
        "FABIANO AUGUSTO PIEDADE","FABIO CAMILO","FERNANDO JOSE DA SILVA FILHO","FLAVIA CRISTINA APARECIDA BICHLER",
        "FLAVIO CARDOSO FLEURY","FRANCISCA EDIVANIA DE MORAIS COSTA","GABRIELA SERIGHELLI DE MELO","GELSON DE ALMEIDA BATISTA",
        "GENILTON DE OLIVEIRA SILVA","GIANI CRISTINA DO PRADO","INGRYD CAROLINA SUGUIMOTO VIEIRA","IVANILDES DOS SANTOS OSHIKAWA",
        "JANINA DOS PASSOS BRAGA DE ALMEIDA","JOSE APARECIDO DA SILVA","JUAREZ GOMES DE MAGALHAES FILHO","JUREMA SOLEDADE FURINI SANTOS",
        "KATIUSCIA ALVES BOMFIM","LUANA CAROLINE ALVES LIMA","LUANA DE FREITAS SILVA","LUCIANA NOVAIS CORREIA SANTOS",
        "LUCIANO MOREIRA DE AZEVEDO","MARCIEL DA SILVA","MARIA HELENA CUNHA MORO","MARIA QUITÃ‰RIA FERREIRA DOS SANTOS",
        "MARINA DA CONCEICAO FRANCISCO SILVA","MAURICIO DE BARROS SANTOS","MICHELE DE PINHO MORAES","MOISES ANTONIO DE BARROS",
        "PAULA ARMANI VILA","PAULO ROBERTO DA SILVA ITO","PEDRO ZANOTTI FILHO","RAUL PEREIRA VILERA JUNIOR",
        "REGIANE CURTI DE SOUZA OLIVEIRA","REGINA DA SILSA CASTRO","RICARDO AMERICO DA SILVA","ROBERTO SALGADO",
        "RODRIGO VIEIRA","ROSANGELA CAFASSO MOREIRA","ROSIMERY DE SOUZA PESSOA","ROSMARA DA SILSA CARDOSO",
        "SANDRA CRISTINA MACEDO MORAES","SELMA GOMES DA SILSA","SERGIO AGRIPINO VILLA NOVA","SOLANGE ALMEIDA DA SILSA",
        "SUZINEIDE SILSA DE FREITAS","THIAGO FABIANO BRITO","TITTO AUGUSTO NASCIMENTO SILSA","VANDERSON HYPPOLITO",
        "VANESSA IVETE GOMES DOS SANTOS","VANIA PENHA DE BARROS","VIVIANE LEAL CAMERA DE MORAES","WILSON RODRIGUES MOTA"
      ];
    }
  </script>
</body>
</html>
