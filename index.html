
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Ocorrências Escolares</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary-color: #f8f9fa;
            --accent-color: #f1c40f;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --border-color: #dadce0;
            --text-color: #202124;
            --light-text: #5f6368;
            --card-bg: #ffffff;
            --header-bg: #ffffff;
            --footer-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --hover-bg: #f0f5ff;
            --morning-color: #3498db;
            --afternoon-color: #f39c12;
            --night-color: #9b59b6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 60px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #2ecc71 0%, #3498db 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo h1 {
            font-size: 1.6rem;
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .logo p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 3px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        main {
            padding: 30px 0;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #2ecc71 0%, #3498db 100%);
            color: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to top, rgba(255,255,255,0.3), transparent);
            z-index: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
            position: relative;
            z-index: 2;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: var(--transition);
        }
        
        .stat-item:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
        }
        
        .card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to top, rgba(255,255,255,0.8), transparent);
            z-index: 1;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 30px;
            font-size: 1.35rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        
        .card-body {
            padding: 30px;
            position: relative;
            z-index: 2;
        }
        
        .student-occurrences-card {
            background: linear-gradient(135deg, #2ecc71 0%, #3498db 100%);
            color: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            margin-top: 25px;
            display: none;
        }
        
        .student-occurrences-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to top, rgba(255,255,255,0.3), transparent);
            z-index: 1;
        }
        
        .student-occurrences-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        
        .student-occurrences-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .student-occurrences-count {
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
            text-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        
        .student-occurrences-label {
            font-size: 1.1rem;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .form-group:hover label {
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .required::after {
            content: " *";
            color: var(--error-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: 16px;
            transition: var(--transition);
            background-color: #f8fafc;
        }
        
        input:hover, select:hover, textarea:hover {
            border-color: var(--primary-color);
            background-color: var(--hover-bg);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            transform: translateY(-2px);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.2);
            background-color: white;
            transform: translateY(-2px);
        }
        
        .input-error {
            border-color: var(--error-color) !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2) !important;
            animation: shake 0.5s ease-in-out;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .checkbox-group {
            margin-bottom: 20px;
        }
        
        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--secondary-color);
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: var(--transition);
        }
        
        .checkbox-item:hover {
            background-color: var(--hover-bg);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            accent-color: var(--primary-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            margin-bottom: 0;
            font-weight: normal;
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
        }
        
        .btn-submit {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-submit:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-submit:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .table-responsive {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--card-bg);
            min-width: 800px; /* Garante que a tabela não fique muito estreita */
        }

        .data-table th, .data-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .data-table tbody tr:hover {
            background-color: var(--hover-bg);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .no-records {
            text-align: center;
            padding: 30px !important;
            font-style: italic;
            color: var(--light-text);
        }

        .btn-action {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-action i {
            font-size: 0.8rem;
        }

        .btn-edit {
            background-color: var(--accent-color);
            color: var(--text-color);
            margin-right: 5px;
        }

        .btn-edit:hover {
            background-color: #e6b800;
        }

        .btn-delete {
            background-color: var(--error-color);
            color: white;
        }

        .btn-delete:hover {
            background-color: #c0392b;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 280px;
            max-width: 350px;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--error-color);
        }

        .notification .icon {
            font-size: 1.5rem;
        }

        .notification .close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: auto;
        }

        .enhanced-success {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            border-left: 8px solid #27ae60;
            padding: 20px 25px;
        }

        .enhanced-success .content {
            flex-grow: 1;
        }

        .enhanced-success strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .enhanced-success .success-details {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-top: 5px;
        }

        .enhanced-success .success-details div {
            margin-bottom: 2px;
        }

        .enhanced-success .close {
            font-size: 1.3rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .export-buttons button {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .export-buttons button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .student-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .student-search-container input {
            flex-grow: 1;
        }

        .student-search-container button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .student-search-container button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Responsividade */
        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .logo {
                margin-bottom: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .card-header {
                padding: 15px 20px;
                font-size: 1.2rem;
            }

            .card-body {
                padding: 20px;
            }

            .form-group label {
                font-size: 1rem;
            }

            input, select, textarea {
                padding: 12px;
            }

            .btn-submit {
                padding: 12px 20px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .logo h1 {
                font-size: 1.4rem;
            }

            .logo p {
                font-size: 0.8rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .stat-label {
                font-size: 0.8rem;
            }

            .checkbox-container {
                grid-template-columns: 1fr;
            }

            .notification {
                min-width: unset;
                max-width: 90%;
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body>
    <div class="notification-container"></div>

    <header>
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-school"></i>
                </div>
                <div class="logo-text">
                    <h1>Sistema de Ocorrências</h1>
                    <p>Gestão Escolar Simplificada</p>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="dashboard">
            <div class="stats-card">
                <h2>Visão Geral</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalOccurrences">0</div>
                        <div class="stat-label">Ocorrências Registradas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Alunos Cadastrados</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalTeachers">0</div>
                        <div class="stat-label">Professores Ativos</div>
                    </div>
                </div>
            </div>
            <div class="card student-occurrences-card" id="studentOccurrencesCard">
                <div class="student-occurrences-content">
                    <div class="student-occurrences-name" id="studentOccurrencesName"></div>
                    <div class="student-occurrences-count" id="studentOccurrencesCount">0</div>
                    <div class="student-occurrences-label">Ocorrências Registradas</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <i class="fas fa-file-alt"></i>
                Registrar Nova Ocorrência
            </div>
            <div class="card-body">
                <form id="occurrenceForm">
                    <div class="form-group">
                        <label for="professor" class="required">Professor(a):</label>
                        <select id="professor" name="professor" required>
                            <option value="">Carregando professores...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="occurrenceDate" class="required">Data da Ocorrência:</label>
                        <input type="date" id="occurrenceDate" name="occurrenceDate" required>
                    </div>

                    <div class="form-group">
                        <label for="studentClass" class="required">Turma:</label>
                        <select id="studentClass" name="studentClass" required>
                            <option value="">Selecione a turma</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="student" class="required">Aluno(a):</label>
                        <select id="student" name="student" required>
                            <option value="">Selecione o aluno</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">Irregularidades:</label>
                        <div class="checkbox-container" id="irregularitiesContainer">
                            <!-- Checkboxes serão gerados aqui pelo JS -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Descrição Detalhada:</label>
                        <textarea id="description" name="description" rows="5" placeholder="Descreva a ocorrência em detalhes..."></textarea>
                    </div>

                    <button type="submit" class="btn-submit" id="submitBtn">
                        <i class="fas fa-save"></i> Registrar Ocorrência
                    </button>
                </form>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar"></i>
                Estatísticas de Ocorrências por Período
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="periodChart"></canvas>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <i class="fas fa-list-alt"></i>
                Registros Recentes
            </div>
            <div class="card-body">
                <div class="student-search-container">
                    <input type="text" id="studentSearchInput" placeholder="Buscar ocorrências de aluno...">
                    <button id="searchStudentBtn"><i class="fas fa-search"></i> Buscar</button>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Professor</th>
                                <th>Turma</th>
                                <th>Aluno</th>
                                <th>Irregularidades</th>
                                <th>Descrição</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="registrosTableBody">
                            <!-- Dados das ocorrências serão carregados aqui -->
                        </tbody>
                    </table>
                </div>
                <div class="export-buttons">
                    <button id="exportExcelBtn"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('occurrenceForm');
            const professorSelect = document.getElementById('professor');
            const classSelect = document.getElementById('studentClass');
            const studentSelect = document.getElementById('student');
            const irregularitiesContainer = document.getElementById('irregularitiesContainer');
            const registrosTableBody = document.getElementById('registrosTableBody');
            const studentSearchInput = document.getElementById('studentSearchInput');
            const searchStudentBtn = document.getElementById('searchStudentBtn');
            const studentOccurrencesCard = document.getElementById('studentOccurrencesCard');
            const studentOccurrencesName = document.getElementById('studentOccurrencesName');
            const studentOccurrencesCount = document.getElementById('studentOccurrencesCount');
            const exportExcelBtn = document.getElementById('exportExcelBtn');

            // URL do seu Google Apps Script implantado como API da Web
            const BACKEND_URL = "https://script.google.com/macros/s/AKfycby-aOeffUZ5zVjLkxgOJRGCnx4u63oYXRhnY1bX3zoMxA48y_58ji29PONFBdSkt0Kr/exec";

            // Variáveis globais
            let currentEditId = null;
            let charts = {};
            let availableClasses = [];

            // Lista de irregularidades
            const irregularities = [
                'Indisciplina',
                'Atraso',
                'Falta',
                'Uso Indevido de Celular',
                'Desrespeito ao Professor',
                'Desrespeito aos Colegas',
                'Não Fez Tarefa',
                'Não Trouxe Material',
                'Conversa Excessiva',
                'Saída da Sala sem Autorização',
                'Uso de Linguagem Inadequada',
                'Agressão Física',
                'Agressão Verbal',
                'Bullying',
                'Vandalismo',
                'Porte de Objeto Inadequado',
                'Cola / Fraude',
                'Dormir em Sala',
                'Fuga da Escola',
                'Uso de Substância Ilícita',
                'Agressão ao Patrimônio Escolar'
            ];

            // Função para exibir notificações
            function showNotification(type, message) {
                const container = document.querySelector('.notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} icon"></i>
                    <span>${message}</span>
                    <button class="close"><i class="fas fa-times"></i></button>
                `;
                container.appendChild(notification);

                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);

                notification.querySelector('.close').addEventListener('click', () => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove());
                });

                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, 5000);
            }

            // Carregar professores
            async function loadTeachers() {
                try {
                    const response = await fetch(`${BACKEND_URL}?endpoint=teachers`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        professorSelect.innerHTML = '<option value="">Selecione seu nome</option>';
                        data.teachers.forEach(teacher => {
                            const option = document.createElement('option');
                            option.value = teacher;
                            option.textContent = teacher;
                            professorSelect.appendChild(option);
                        });
                        document.getElementById('totalTeachers').textContent = data.teachers.length;
                    }
                } catch (error) {
                    console.error('Erro ao carregar professores:', error);
                    showNotification('error', 'Erro ao carregar lista de professores');
                }
            }

            // Carregar turmas
            async function loadClasses() {
                try {
                    const response = await fetch(`${BACKEND_URL}?endpoint=classes`);
                    const data = await response.json();
                    if (data.status === 'success') {
                        availableClasses = data.classes;
                        classSelect.innerHTML = '<option value="">Selecione a turma</option>';
                        availableClasses.forEach(className => {
                            const option = document.createElement('option');
                            option.value = className;
                            option.textContent = className;
                            classSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Erro ao carregar turmas:', error);
                    showNotification('error', 'Erro ao carregar lista de turmas');
                }
            }

            // Carregar alunos baseado na turma selecionada
            async function loadStudents(selectedClass) {
                studentSelect.innerHTML = '<option value="">Carregando alunos...</option>';
                studentSelect.disabled = true;
                try {
                    const response = await fetch(`${BACKEND_URL}?endpoint=students&turma=${encodeURIComponent(selectedClass)}`);
                    const data = await response.json();
                    if (data.status === 'success') {
                        studentSelect.innerHTML = '<option value="">Selecione o aluno</option>';
                        data.students.forEach(studentName => {
                            const option = document.createElement('option');
                            option.value = studentName;
                            option.textContent = studentName;
                            studentSelect.appendChild(option);
                        });
                        document.getElementById('totalStudents').textContent = data.students.length; // Atualiza o total de alunos
                    } else {
                        showNotification('error', data.message || 'Erro ao carregar alunos.');
                        studentSelect.innerHTML = '<option value="">Nenhum aluno encontrado</option>';
                    }
                } catch (error) {
                    console.error('Erro ao carregar alunos:', error);
                    showNotification('error', 'Erro ao carregar lista de alunos');
                    studentSelect.innerHTML = '<option value="">Erro ao carregar alunos</option>';
                } finally {
                    studentSelect.disabled = false;
                }
            }

            // Gerar checkboxes de irregularidades
            function generateIrregularitiesCheckboxes() {
                irregularitiesContainer.innerHTML = '';
                irregularities.forEach(irr => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="irr_${irr.replace(/\s/g, '_')}" name="irregularities" value="${irr}">
                        <label for="irr_${irr.replace(/\s/g, '_')}">${irr}</label>
                    `;
                    irregularitiesContainer.appendChild(div);
                });
            }

            // Carregar tabela de registros
            async function loadRegistrosTable() {
                try {
                    const response = await fetch(`${BACKEND_URL}?endpoint=occurrences&sheet=OCORRENCIASDOSPROFESSORES`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        const tbody = registrosTableBody;
                        tbody.innerHTML = '';

                        if (data.occurrences.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" class="no-records">Nenhuma ocorrência registrada</td></tr>';
                        } else {
                            data.occurrences.forEach(occurrence => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${new Date(occurrence.data || occurrence.date || occurrence['Data']).toLocaleDateString('pt-BR')}</td>
                                    <td>${occurrence.professor || occurrence['Professor']}</td>
                                    <td>${occurrence.turma || occurrence.studentClass || occurrence['Turma']}</td>
                                    <td>${occurrence.aluno || occurrence.student || occurrence['Aluno']}</td>
                                    <td>${occurrence.irregularidades || occurrence.irregularities || occurrence['Irregularidades']}</td>
                                    <td>${occurrence.descricao || occurrence.description || occurrence['Descrição'] || ''}</td>
                                    <td class="actions-cell">
                                        <button class="btn-action btn-delete" onclick="deleteOccurrence(${occurrence.id})">
                                            <i class="fas fa-trash"></i> Excluir
                                        </button>
                                    </td>
                                `;
                                tbody.appendChild(row);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar registros:', error);
                    showNotification('error', 'Erro ao carregar registros de ocorrências');
                }
            }

            // FUNÇÃO PRINCIPAL APRIMORADA - Manipular envio do formulário
            async function handleFormSubmit(e) {
                e.preventDefault();

                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                
                // Desabilitar botão e mostrar estado de carregamento
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading"></div> Processando...';
                
                // Adicionar classe de carregamento ao formulário
                form.classList.add('form-loading');

                try {
                    // Validação completa do formulário
                    const validationResult = validateFormComplete();
                    if (!validationResult.isValid) {
                        showNotification('error', validationResult.message);
                        highlightInvalidFields(validationResult.invalidFields);
                        return;
                    }

                    // Captura os valores do formulário
                    const professor = professorSelect.value.trim();
                    const turma = classSelect.value.trim();
                    const aluno = studentSelect.value.trim();
                    const descricao = document.getElementById('description').value.trim();
                    const dataOcorrencia = document.getElementById('occurrenceDate').value;

                    // Coleta irregularidades marcadas
                    const irregularidadesSelecionadas = Array.from(
                        document.querySelectorAll('#irregularitiesContainer input[type="checkbox"]:checked')
                    ).map(cb => cb.value);

                    // Atualizar estado do botão
                    submitBtn.innerHTML = '<div class="loading"></div> Salvando no sistema...';

                    // Monta o corpo da requisição
                    const data = {
                        endpoint: 'create-occurrence',
                        sheet: 'OCORRENCIASDOSPROFESSORES',
                        date: new Date().toISOString(),
                        occurrenceDate: dataOcorrencia,
                        professor: professor,
                        studentClass: turma,
                        student: aluno,
                        description: descricao,
                        irregularities: irregularidadesSelecionadas.join(', ')
                    };

                    // Envio para o backend
                    submitBtn.innerHTML = '<div class="loading"></div> Conectando com servidor...';
                    
                    const response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro do servidor: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        // Feedback visual de sucesso
                        showEnhancedSuccessNotification(professor, aluno, turma);
                        
                        // Reset inteligente do formulário (mantém professor e data)
                        intelligentFormReset();
                        
                        // Recarregar dados atualizados
                        await Promise.all([
                            loadRegistrosTable(),
                            loadStatistics(),
                            updateStudentStatsIfSelected(aluno)
                        ]);
                        
                    } else {
                        throw new Error(result.message || 'Erro desconhecido ao registrar ocorrência.');
                    }

                } catch (error) {
                    console.error('Erro detalhado ao salvar ocorrência:', error);
                    
                    // Determinar mensagem de erro mais amigável
                    const userFriendlyMessage = getFriendlyErrorMessage(error);
                    showNotification('error', `Erro ao salvar ocorrência: ${userFriendlyMessage}`);
                    
                } finally {
                    // Restaurar estado original
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    form.classList.remove('form-loading');
                    
                    // Remover highlights de erro
                    clearFieldHighlights();
                }
            }

            // Funções auxiliares para os aprimoramentos
            function validateFormComplete() {
                const requiredFields = [
                    { id: 'professor', name: 'Professor' },
                    { id: 'occurrenceDate', name: 'Data da ocorrência' },
                    { id: 'studentClass', name: 'Turma' },
                    { id: 'student', name: 'Aluno' }
                ];

                const invalidFields = [];
                
                for (const field of requiredFields) {
                    const element = document.getElementById(field.id);
                    if (!element.value.trim()) {
                        invalidFields.push(field);
                    }
                }

                // Validar pelo menos uma irregularidade selecionada
                const selectedIrregularities = document.querySelectorAll('#irregularitiesContainer input[type="checkbox"]:checked');
                if (selectedIrregularities.length === 0) {
                    invalidFields.push({ id: 'irregularitiesContainer', name: 'Irregularidades' });
                }

                return {
                    isValid: invalidFields.length === 0,
                    message: invalidFields.length > 0 
                        ? `Por favor, preencha os campos obrigatórios: ${invalidFields.map(f => f.name).join(', ')}`
                        : '',
                    invalidFields: invalidFields
                };
            }

            function highlightInvalidFields(invalidFields) {
                invalidFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    element.classList.add('input-error');
                    
                    // Scroll para o primeiro campo inválido
                    if (invalidFields[0].id === field.id) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }

            function clearFieldHighlights() {
                document.querySelectorAll('.input-error').forEach(element => {
                    element.classList.remove('input-error');
                });
            }

            function showEnhancedSuccessNotification(professor, aluno, turma) {
                // Criar notificação customizada de sucesso
                const notification = document.createElement('div');
                notification.className = 'notification success show enhanced-success';
                notification.innerHTML = `
                    <i class="fas fa-check-circle icon"></i>
                    <div class="content">
                        <strong>Ocorrência registrada com sucesso!</strong>
                        <div class="success-details">
                            <div><strong>Professor:</strong> ${professor}</div>
                            <div><strong>Aluno:</strong> ${aluno}</div>
                            <div><strong>Turma:</strong> ${turma}</div>
                            <div><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</div>
                        </div>
                    </div>
                    <button class="close"><i class="fas fa-times"></i></button>
                `;
                
                document.body.appendChild(notification);
                
                // Configurar botão de fechar
                notification.querySelector('.close').addEventListener('click', () => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove());
                });

                // Remover após 7 segundos
                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, 7000);
            }

            function intelligentFormReset() {
                // Resetar campos específicos, mantendo professor e data
                // classSelect.value = ''; // Não resetar a turma para facilitar múltiplos registros na mesma turma
                studentSelect.innerHTML = '<option value="">Selecione o aluno</option>';
                studentSelect.value = '';
                document.getElementById('description').value = '';
                document.querySelectorAll('#irregularitiesContainer input[type="checkbox"]:checked').forEach(cb => {
                    cb.checked = false;
                });
            }

            function getFriendlyErrorMessage(error) {
                if (error.message.includes('JSON inválido')) {
                    return 'Os dados enviados estão com formato inválido. Tente novamente.';
                } else if (error.message.includes('Erro do servidor: 400')) {
                    return 'Requisição inválida. Verifique os dados e tente novamente.';
                } else if (error.message.includes('Erro do servidor: 500')) {
                    return 'Ocorreu um erro interno no servidor. Por favor, tente mais tarde.';
                } else if (error.message.includes('Failed to fetch')) {
                    return 'Não foi possível conectar ao servidor. Verifique sua conexão ou tente mais tarde.';
                }
                return 'Ocorreu um erro inesperado. Detalhes: ' + error.message;
            }

            // Carregar estatísticas do dashboard
            async function loadStatistics() {
                try {
                    const response = await fetch(`${BACKEND_URL}?endpoint=dashboard-stats`);
                    const data = await response.json();
                    if (data.status === 'success') {
                        document.getElementById('totalOccurrences').textContent = data.totalOccurrences;
                        document.getElementById('totalStudents').textContent = data.totalStudents;
                        document.getElementById('totalTeachers').textContent = data.totalTeachers;
                    }
                } catch (error) {
                    console.error('Erro ao carregar estatísticas do dashboard:', error);
                    showNotification('error', 'Erro ao carregar estatísticas gerais.');
                }
            }

            // Carregar estatísticas por período para o gráfico
            async function loadPeriodStats() {
                try {
                    const response = await fetch(`${BACKEND_URL}?endpoint=period-stats`);
                    const data = await response.json();
                    if (data.status === 'success') {
                        updatePeriodChart(data.morning, data.afternoon, data.night);
                    }
                } catch (error) {
                    console.error('Erro ao carregar estatísticas de período:', error);
                    showNotification('error', 'Erro ao carregar estatísticas por período.');
                }
            }

            // Atualizar gráfico de período
            function updatePeriodChart(morning, afternoon, night) {
                const ctx = document.getElementById('periodChart').getContext('2d');
                if (charts.periodChart) {
                    charts.periodChart.destroy();
                }
                charts.periodChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Manhã', 'Tarde', 'Noite'],
                        datasets: [{
                            data: [morning, afternoon, night],
                            backgroundColor: [
                                'var(--morning-color)',
                                'var(--afternoon-color)',
                                'var(--night-color)'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'var(--text-color)'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Ocorrências por Período do Dia',
                                color: 'var(--text-color)',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }

            // Função para buscar e exibir estatísticas de um aluno específico
            async function searchStudentOccurrences() {
                const studentName = studentSearchInput.value.trim();
                if (!studentName) {
                    showNotification('error', 'Por favor, digite o nome do aluno para buscar.');
                    studentOccurrencesCard.style.display = 'none';
                    return;
                }

                try {
                    const response = await fetch(`${BACKEND_URL}?endpoint=student-stats&aluno=${encodeURIComponent(studentName)}`);
                    const data = await response.json();

                    if (data.status === 'success') {
                        studentOccurrencesName.textContent = data.studentName;
                        studentOccurrencesCount.textContent = data.occurrenceCount;
                        studentOccurrencesCard.style.display = 'block';
                    } else {
                        showNotification('error', data.message || 'Erro ao buscar ocorrências do aluno.');
                        studentOccurrencesCard.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Erro ao buscar ocorrências do aluno:', error);
                    showNotification('error', 'Erro ao buscar ocorrências do aluno.');
                    studentOccurrencesCard.style.display = 'none';
                }
            }

            // Função para atualizar as estatísticas do aluno se ele estiver selecionado no formulário
            async function updateStudentStatsIfSelected(aluno) {
                if (studentSelect.value === aluno) {
                    await searchStudentOccurrences();
                }
            }

            // Exportar dados
            async function exportData() {
                try {
                    const response = await fetch(`${BACKEND_URL}?endpoint=occurrences&sheet=OCORRENCIASDOSPROFESSORES`);
                    const data = await response.json();
                    
                    if (data.status === 'success' && Array.isArray(data.occurrences)) {
                        // Preparar dados para exportação
                        const wsData = data.occurrences.map(occurrence => [
                            new Date(occurrence.data || occurrence.date || occurrence['Data']).toLocaleDateString('pt-BR'),
                            occurrence.professor || occurrence['Professor'],
                            occurrence.turma || occurrence.studentClass || occurrence['Turma'],
                            occurrence.aluno || occurrence.student || occurrence['Aluno'],
                            occurrence.irregularidades || occurrence.irregularities || occurrence['Irregularidades'],
                            occurrence.descricao || occurrence.description || occurrence['Descrição'] || ''
                        ]);

                        // Adicionar cabeçalhos
                        const headers = ['Data', 'Professor', 'Turma', 'Aluno', 'Irregularidades', 'Descrição'];
                        wsData.unshift(headers);

                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Ocorrências");
                        XLSX.writeFile(wb, "ocorrencias_professores.xlsx");
                        showNotification('success', 'Dados exportados com sucesso para Excel!');
                    } else {
                        showNotification('error', data.message || 'Erro ao exportar dados: Nenhuma ocorrência encontrada ou erro no servidor.');
                    }
                } catch (error) {
                    console.error('Erro ao exportar dados:', error);
                    showNotification('error', 'Erro ao exportar dados para Excel.');
                }
            }

            // Event Listeners
            form.addEventListener('submit', handleFormSubmit);
            classSelect.addEventListener('change', (e) => loadStudents(e.target.value));
            searchStudentBtn.addEventListener('click', searchStudentOccurrences);
            studentSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchStudentOccurrences();
                }
            });
            exportExcelBtn.addEventListener('click', exportData);

            // Inicialização
            await loadTeachers();
            await loadClasses();
            generateIrregularitiesCheckboxes();
            await loadRegistrosTable();
            await loadStatistics();
            await loadPeriodStats();

            // Define a data atual como valor padrão para o campo de data da ocorrência
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Janeiro é 0!
            const year = today.getFullYear();
            document.getElementById('occurrenceDate').value = `${year}-${month}-${day}`;
        });

        // Funções globais para botões de ação na tabela (se necessário, ou reestruturar)
        async function deleteOccurrence(id) {
            if (!confirm('Tem certeza que deseja excluir esta ocorrência?')) {
                return;
            }
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        endpoint: 'delete-occurrence',
                        id: id
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro do servidor: ${response.status} - ${errorText}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    showNotification('success', 'Ocorrência excluída com sucesso!');
                    // Recarregar dados
                    await loadRegistrosTable();
                    await loadStatistics();
                    await loadPeriodStats();
                } else {
                    throw new Error(result.message || 'Erro desconhecido ao excluir ocorrência.');
                }
            } catch (error) {
                console.error('Erro ao excluir ocorrência:', error);
                showNotification('error', `Erro ao excluir ocorrência: ${error.message}`);
            }
        }
    </script>
</body>
</html>
