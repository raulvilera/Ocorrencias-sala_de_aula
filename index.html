<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorrências - 2025</title>

  <!-- Microsoft Graph API support -->
  <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
  
  <!-- jsPDF para geração local de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ===== Reset/Base ===== */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,#9fe7ff 0%, #b9f7c9 60%, #baf3ff 100%);
      color:#fff; font-weight:800; padding:18px;
    }
    .app{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px;border-radius:14px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    header h1{font-size:20px;margin:0}
    .header-controls{display:flex;gap:10px;align-items:center}
    .card{background:#2f3336;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    .flex{display:flex;gap:18px;align-items:flex-start}
    .col{display:flex;flex-direction:column;gap:12px}
    label{display:block;margin-bottom:6px;font-size:13px}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      width:100%;padding:10px 12px;border-radius:8px;border:none;font-weight:800;font-size:14px;color:#111
    }
    textarea{min-height:110px;resize:vertical;padding-top:12px}
    button{cursor:pointer;border:none;padding:10px 14px;border-radius:8px;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,0.15)}
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff}
    .btn-secondary{background:linear-gradient(90deg,#6c757d,#5a6268);color:#fff}
    .subtitle{font-size:14px;color:#d9f2ff;margin-bottom:6px}
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:6px}
    .historyItem{background:rgba(255,255,255,0.06);border-left:5px solid rgba(255,255,255,0.06);padding:12px;border-radius:8px;color:#fff;font-weight:700}
    .historyItem .meta{font-size:13px;color:#dbefff;font-weight:800;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .historyItem .desc{margin-top:8px;color:#e7f7ff;font-weight:600;font-size:14px}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:2000}
    .modal{width:92%;max-width:780px;background:#fff;color:#111;border-radius:12px;padding:14px;max-height:84vh;overflow:auto}
    .studentList{display:flex;flex-direction:column;gap:8px}
    .pill{background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 10px;border-radius:999px;font-weight:800;display:inline-block}
    .muted{opacity:.9;font-weight:700;color:#e7f7ff}
    .qnum{color:#ff3b3b;font-weight:900}
    .login-options {display: flex; gap: 12px; margin-bottom: 18px;}
    .login-option {flex: 1; text-align: center; padding: 12px; border-radius: 8px; cursor: pointer; background: rgba(255,255,255,0.1);}
    .login-option.active {background: linear-gradient(90deg, rgba(0,78,120,0.8), rgba(0,120,120,0.8));}
    .access-area {display: none;}
    
    /* Novos estilos para formulários - Área de Gestão com campos mais largos */
    .form-row {display: flex; gap: 12px; margin-bottom: 12px;}
    .form-group {flex: 1; display: flex; flex-direction:column;}
    .form-group label {margin-bottom: 6px;}
    .form-group-small {flex: 0.5;}
    .form-group-medium {flex: 1.2;}
    .form-group-large {flex: 2;}
    .form-group-xlarge {flex: 2.5;}
    
    /* Ajustes específicos para a área de gestão */
    .gestao-form .form-group {flex: 1;}
    .gestao-form .form-row {margin-bottom: 15px;}
    .gestao-form input, 
    .gestao-form select, 
    .gestao-form textarea {
        width: 100%;
        padding: 12px;
        font-size: 15px;
    }
    
    .checkbox-group {display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;}
    .checkbox-item {background: #efefef; color: #111; padding: 6px 10px; border-radius: 999px; display: inline-flex; align-items: center;}
    .checkbox-item input {margin-right: 4px;}
    
    /* Estilo específico para o campo Classificação */
    .classification-container {display: flex; flex-direction: column; width: auto; min-width: 250px;}
    
    @media(max-width:980px){
      .flex{flex-direction:column}
      header{flex-direction:column;gap:8px;align-items:flex-start} 
      .login-options {flex-direction: column;}
      .form-row {flex-direction: column;}
      .classification-container {width: 100%;}
      .gestao-form .form-row {flex-direction: column;}
    }
    
    /* loader animation */
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader{width:18px;height:18px;border:3px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block}
    
    /* Status messages */
    .status-message {padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center;}
    .status-success {background: linear-gradient(90deg, #4CAF50, #2E7D32);}
    .status-error {background: linear-gradient(90deg, #e94b4b, #c62828);}
    .status-info {background: linear-gradient(90deg, #2196F3, #0D47A1);}
  </style>
</head>
<body>
  <div class="app">

    <!-- HEADER -->
    <header>
      <h1>2025 — Cadastro de Ocorrências</h1>
      <div class="header-controls">
        <div id="userDisplay" class="muted">Não autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
        <button id="btnSharePointLogin" class="btn-success" style="display:none" onclick="loginToSharePoint()">Conectar SharePoint</button>
        <button id="btnDownloadPdf" class="btn-success" style="display:none" onclick="downloadDocument()">Baixar Template</button>
      </div>
    </header>

    <!-- Status Message Area -->
    <div id="statusMessage" style="display:none"></div>

    <!-- LOGIN -->
    <div id="loginScreen" class="card" style="display:block">
      <div style="max-width:480px;margin:0 auto">
        <div class="subtitle">Selecione o tipo de acesso</div>
        
        <div class="login-options">
          <div class="login-option active" id="optionGestao" onclick="selectLoginOption('gestao')">
            Acesso Gestão
          </div>
          <div class="login-option" id="optionProfessor" onclick="selectLoginOption('professor')">
            Acesso Professor
          </div>
        </div>
        
        <div id="loginFormGestao" class="access-area">
          <div class="form-row">
            <div class="form-group form-group-xlarge">
              <label for="emailGestao">E-mail Gestão</label>
              <input id="emailGestao" type="email" placeholder="gestao@escola.com">
            </div>
            <div class="form-group form-group-medium">
              <label for="passwordGestao">Senha</label>
              <input id="passwordGestao" type="password" placeholder="senha">
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn-primary" onclick="login('gestao')">Entrar como Gestão</button>
            <button class="btn-danger" onclick="fillDemo('gestao')">Demo Gestão</button>
          </div>
          <p class="muted" style="margin-top:10px;font-size:13px">
            Use <strong>gestao@escola.com / gestao123</strong> para acesso à gestão
          </p>
        </div>
        
        <div id="loginFormProfessor" class="access-area">
          <div class="form-row">
            <div class="form-group form-group-xlarge">
              <label for="emailProfessor">E-mail Professor</label>
              <input id="emailProfessor" type="email" placeholder="professor@escola.com">
            </div>
            <div class="form-group form-group-medium">
              <label for="passwordProfessor">Senha</label>
              <input id="passwordProfessor" type="password" placeholder="senha">
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn-primary" onclick="login('professor')">Entrar como Professor</button>
            <button class="btn-danger" onclick="fillDemo('professor')">Demo Professor</button>
          </div>
          <p class="muted" style="margin-top:10px;font-size:13px">
            Use <strong>professor@escola.com / prof123</strong> para acesso ao professor
          </p>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GESTÃO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <!-- GESTÃO -->
        <div class="card col" style="flex:1">
          <div class="subtitle">CADASTRO — GESTÃO</div>
          <div class="col gestao-form">
            <!-- Série/Turma em primeiro lugar -->
            <div class="form-row">
              <div class="form-group form-group-xlarge">
                <label>Série / Turma</label>
                <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                  <option value="">-- Selecione a turma --</option>
                </select>
              </div>
            </div>
            
            <!-- Aluno e RA -->
            <div class="form-row">
              <div class="form-group form-group-xlarge">
                <label>Aluno</label>
                <select id="aluno_gestao" onchange="preencherRAGestao(this.value)">
                  <option value="">-- Selecione o aluno --</option>
                </select>
              </div>
              <div class="form-group form-group-medium">
                <label>RA</label>
                <input id="ra_gestao" type="text" readonly>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group form-group-xlarge">
                <label>Professor</label>
                <input id="professor_gestao" type="text">
              </div>
              <div class="form-group form-group-xlarge">
                <label>Disciplina</label>
                <input id="disciplina_gestao" type="text">
              </div>
            </div>
            
            <!-- Classificação com largura ajustada -->
            <div class="form-row">
              <div class="classification-container">
                <label>Classificação</label>
                <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                  <option value="">Selecione</option>
                  <option value="OCORRÊNCIA">OCORRÊNCIA</option>
                  <option value="SUSPENSÃO">SUSPENSÃO</option>
                </select>
              </div>
              <div class="form-group" style="display:none" id="suspensionRow_gestao">
                <label>Data de retorno</label>
                <input id="dataRetorno_gestao" type="date">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Descrição</label>
                <textarea id="descricao_gestao" placeholder="Descrição detalhada"></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gestão)</button>
              <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
            </div>

            <div id="successGestao" style="display:none;margin-top:10px;background:linear-gradient(90deg,#4CAF50,#2E7D32);padding:10px;border-radius:8px;color:#fff;font-weight:900">
              Ocorrência registrada com sucesso!
            </div>
          </div>
        </div>
      </div>

      <!-- HISTÓRICO GESTÃO -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - GESTÃO</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button>
          </div>
        </div>
        <div style="margin-top:12px" id="historyListGestao" class="historyList"></div>
      </div>
    </div> <!-- mainAppGestao -->

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <!-- PROFESSOR -->
        <div class="card col" style="flex:1">
          <div class="subtitle">REGISTRO — PROFESSOR</div>
          <div class="col">
            <div class="form-row">
              <div class="form-group">
                <label>Professor</label>
                <select id="professor_select"></select>
              </div>
              <div class="form-group">
                <label>Turma</label>
                <select id="turma_select" onchange="onTurmaChange()"></select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group form-group-large">
                <label>Alunos (clique para selecionar)</label>
                <input id="alunos_selected_input" type="text" readonly placeholder="Clique para selecionar" onclick="openStudentsModal()">
                <div id="selectedPills" style="margin-top:8px"></div>
              </div>
              <div class="form-group form-group-small">
                <label>Data</label>
                <input id="data_prof" type="date">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Irregularidades</label>
                <div class="checkbox-group">
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Agressão"> Agressão
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Danos ao patrimônio"> Danos ao patrimônio
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Desacato"> Desacato
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Falta de material"> Falta de material
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Não realiza as atividades"> Não realiza as atividades
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Saiu da sala sem autorização"> Saiu da sala sem autorização
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Descrição</label>
                <textarea id="descricao_prof" placeholder="Descreva a ocorrência..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
              <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
            </div>

            <div id="successProfessor" style="display:none;margin-top:10px;background:linear-gradient(90deg,#4CAF50,#2E7D32);padding:10px;border-radius:8px;color:#fff;font-weight:900">
              Ocorrência registrada com sucesso!
            </div>
          </div>
        </div>
      </div>

      <!-- HISTÓRICO PROFESSOR -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - PROFESSOR</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button>
          </div>
        </div>
        <div style="margin-top:12px" id="historyListProfessor" class="historyList"></div>
      </div>
    </div> <!-- mainAppProfessor -->

    <!-- MODAL SELEÇÃO ALUNOS -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong>Selecionar alunos</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-weight:900;cursor:pointer">✕</button>
        </header>

        <div>
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px" oninput="filterStudentList()">
          <div id="studentList" class="studentList"></div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    /*******************************
     * CONFIGURAÇÕES SHAREPOINT
     *******************************/
    const SHAREPOINT_CONFIG = {
      // URL da planilha no SharePoint
      spreadsheetUrl: 'https://seducsp-my.sharepoint.com/:x:/g/personal/e923357w10_professor_educacao_sp_gov_br/ETvYABRMB_FDoN8efg3Fsu4BqRNmyRGlEGfKEIfF8EeEHA?e=RDh9Fs',
      
      // Nome da aba onde os registros serão salvos
      sheetName: 'Planilha1',
      
      // Configuração MSAL para autenticação Microsoft
      msalConfig: {
        auth: {
          clientId: 'YOUR_CLIENT_ID', // Você precisa registrar um app no Azure AD
          authority: 'https://login.microsoftonline.com/common',
          redirectUri: window.location.origin
        },
        cache: {
          cacheLocation: 'sessionStorage',
          storeAuthStateInCookie: false
        }
      }
    };

    // estado
    let allAlunos = [];
    let alunosDaTurmaAtual = [];
    let alunosSelecionados = [];
    let professores = [];
    let turmas = [];
    let currentUserRole = null;
    let alunosComRA = [];
    let sharePointAccessToken = null;

    // MSAL instance
    let msalInstance = null;

    // inicial
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      selectLoginOption('gestao');
      carregarTurmasGestao();
      
      // Inicializar MSAL
      initializeMSAL();
    });

    // Inicializar Microsoft Authentication Library
    function initializeMSAL() {
      try {
        msalInstance = new msal.PublicClientApplication(SHAREPOINT_CONFIG.msalConfig);
        checkSharePointAuth();
      } catch (error) {
        console.error('Erro ao inicializar MSAL:', error);
      }
    }

    // Verificar autenticação existente
    async function checkSharePointAuth() {
      try {
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
          const silentRequest = {
            scopes: ['https://graph.microsoft.com/.default'],
            account: accounts[0]
          };
          
          const response = await msalInstance.acquireTokenSilent(silentRequest);
          sharePointAccessToken = response.accessToken;
          updateSharePointStatus('Conectado ao SharePoint', 'success');
        }
      } catch (error) {
        console.log('Usuário não autenticado no SharePoint');
      }
    }

    // Login no SharePoint
    async function loginToSharePoint() {
      try {
        const loginRequest = {
          scopes: ['https://graph.microsoft.com/.default']
        };
        
        const response = await msalInstance.loginPopup(loginRequest);
        sharePointAccessToken = response.accessToken;
        updateSharePointStatus('Conectado ao SharePoint com sucesso!', 'success');
      } catch (error) {
        console.error('Erro no login SharePoint:', error);
        updateSharePointStatus('Erro ao conectar com SharePoint', 'error');
      }
    }

    // Atualizar status do SharePoint
    function updateSharePointStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.innerHTML = message;
      statusDiv.className = `status-message status-${type}`;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    // Função para salvar dados no SharePoint
    async function saveToSharePoint(data, recordType) {
      if (!sharePointAccessToken) {
        updateSharePointStatus('Conecte-se ao SharePoint primeiro', 'error');
        return false;
      }

      try {
        // Extrair informações do arquivo do SharePoint da URL
        const fileInfo = extractSharePointFileInfo(SHAREPOINT_CONFIG.spreadsheetUrl);
        
        // Primeiro, ler a planilha existente
        const worksheetUrl = `https://graph.microsoft.com/v1.0/sites/${fileInfo.siteId}/drive/items/${fileInfo.itemId}/workbook/worksheets/${SHAREPOINT_CONFIG.sheetName}`;
        
        // Obter o range usado para saber onde adicionar nova linha
        const usedRangeResponse = await fetch(`${worksheetUrl}/usedRange`, {
          headers: {
            'Authorization': `Bearer ${sharePointAccessToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const usedRangeData = await usedRangeResponse.json();
        const lastRow = usedRangeData.rowCount || 1;
        
        // Preparar dados para a nova linha
        const newRow = prepareRowData(data, recordType);
        
        // Adicionar nova linha
        const addRowUrl = `${worksheetUrl}/tables/Table1/rows`;
        const addRowResponse = await fetch(addRowUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${sharePointAccessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            values: [newRow]
          })
        });

        if (addRowResponse.ok) {
          updateSharePointStatus('Dados salvos no SharePoint com sucesso!', 'success');
          return true;
        } else {
          throw new Error('Erro ao adicionar linha');
        }
      } catch (error) {
        console.error('Erro ao salvar no SharePoint:', error);
        updateSharePointStatus('Erro ao salvar no SharePoint', 'error');
        return false;
      }
    }

    // Extrair informações do arquivo do SharePoint da URL
    function extractSharePointFileInfo(url) {
      // Esta é uma simplificação - na prática você precisaria parsear a URL corretamente
      const match = url.match(/personal\/([^\/]+)\/([^\/]+)\/([^?]+)/);
      if (match) {
        return {
          siteId: match[1],
          driveId: match[2],
          itemId: match[3]
        };
      }
      return null;
    }

    // Preparar dados da linha para o SharePoint
    function prepareRowData(data, recordType) {
      const timestamp = new Date().toISOString();
      
      if (recordType === 'gestao') {
        return [
          timestamp,
          data.professor,
          data.studentClass,
          data.student,
          data.ra || '',
          data.disciplina,
          data.irregularities,
          data.description,
          'GESTÃO'
        ];
      } else {
        return [
          timestamp,
          data.professor,
          data.studentClass,
          data.student,
          '',
          '',
          data.irregularities,
          data.description,
          'PROFESSOR'
        ];
      }
    }

    // Selecionar opção de login
    function selectLoginOption(role) {
      document.querySelectorAll('.login-option').forEach(opt => opt.classList.remove('active'));
      document.getElementById(`option${role.charAt(0).toUpperCase() + role.slice(1)}`).classList.add('active');
      
      document.querySelectorAll('.access-area').forEach(area => area.style.display = 'none');
      document.getElementById(`loginForm${role.charAt(0).toUpperCase() + role.slice(1)}`).style.display = 'block';
    }

    // login por tipo de usuário
    function login(role){
      let email, password;
      
      if (role === 'gestao') {
        email = document.getElementById('emailGestao').value.trim();
        password = document.getElementById('passwordGestao').value.trim();
      } else {
        email = document.getElementById('emailProfessor').value.trim();
        password = document.getElementById('passwordProfessor').value.trim();
      }
      
      if(role === 'gestao' && email === 'gestao@escola.com' && password === 'gestao123'){
        showAppAs(role, email);
      } else if(role === 'professor' && email === 'professor@escola.com' && password === 'prof123'){
        showAppAs(role, email);
      } else {
        alert('E-mail ou senha incorretos.');
      }
    }
    
    function fillDemo(role){ 
      if (role === 'gestao') {
        document.getElementById('emailGestao').value='gestao@escola.com'; 
        document.getElementById('passwordGestao').value='gestao123'; 
      } else {
        document.getElementById('emailProfessor').value='professor@escola.com'; 
        document.getElementById('passwordProfessor').value='prof123'; 
      }
    }

    function showAppAs(role, email){
      currentUserRole = role;
      document.getElementById('loginScreen').style.display = 'none';
      
      if (role === 'gestao') {
        document.getElementById('mainAppGestao').style.display = 'flex';
        document.getElementById('mainAppProfessor').style.display = 'none';
        carregarHistoricoGestao();
      } else {
        document.getElementById('mainAppGestao').style.display = 'none';
        document.getElementById('mainAppProfessor').style.display = 'flex';
        carregarProfessoresETurmas();
        carregarHistoricoProfessor();
      }
      
      document.getElementById('userDisplay').textContent = email + (role==='gestao'?' (Gestão)':' (Professor)');
      document.getElementById('btnLogout').style.display = 'inline-block';
      document.getElementById('btnSharePointLogin').style.display = 'inline-block';
      document.getElementById('btnDownloadPdf').style.display = 'inline-block';
    }

    function logout(){
      currentUserRole = null;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainAppGestao').style.display = 'none';
      document.getElementById('mainAppProfessor').style.display = 'none';
      document.getElementById('userDisplay').textContent = 'Não autenticado';
      document.getElementById('btnLogout').style.display = 'none';
      document.getElementById('btnSharePointLogin').style.display = 'none';
      document.getElementById('btnDownloadPdf').style.display = 'none';
      alunosDaTurmaAtual = []; alunosSelecionados = []; document.getElementById('selectedPills').innerHTML='';
      
      // Limpar formulários
      document.getElementById('emailGestao').value = '';
      document.getElementById('passwordGestao').value = '';
      document.getElementById('emailProfessor').value = '';
      document.getElementById('passwordProfessor').value = '';
    }

    /*******************************
     * Funções específicas para a área de gestão
     *******************************/
    
    // Carregar turmas para a área de gestão
    async function carregarTurmasGestao() {
      // Para demonstração - na prática você buscaria do SharePoint
      const turmasDemo = [
        "6° ANO A MANHA", "6° ANO B MANHA", "6° ANO C MANHA", "6° ANO D MANHA",
        "6° ANO E TARDE", "6° ANO F TARDE", "7° ANO A TARDE", "7° ANO B TARDE"
      ];
      
      const turmaSelect = document.getElementById('serie_gestao');
      turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
      turmasDemo.forEach(t => {
        const option = document.createElement('option');
        option.value = t;
        option.textContent = t;
        turmaSelect.appendChild(option);
      });
    }
    
    // Carregar alunos por turma na área de gestão
    async function carregarAlunosPorTurmaGestao(turma) {
      if (!turma) {
        document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
        document.getElementById('ra_gestao').value = '';
        return;
      }
      
      // Dados de demonstração
      const alunosDemo = {
        "6° ANO A MANHA": [
          { nome: "ALUNO A1", ra: "12345" },
          { nome: "ALUNO A2", ra: "12346" },
          { nome: "ALUNO A3", ra: "12347" }
        ],
        "6° ANO B MANHA": [
          { nome: "ALUNO B1", ra: "22345" },
          { nome: "ALUNO B2", ra: "22346" }
        ]
      };
      
      alunosComRA = alunosDemo[turma] || [];
      
      const alunoSelect = document.getElementById('aluno_gestao');
      alunoSelect.innerHTML = '<option value="">-- Selecione o aluno --</option>';
      
      alunosComRA.forEach(aluno => {
        const option = document.createElement('option');
        option.value = aluno.nome;
        option.textContent = aluno.nome;
        option.setAttribute('data-ra', aluno.ra || '');
        alunoSelect.appendChild(option);
      });
    }
    
    // Preencher RA quando selecionar um aluno na área de gestão
    function preencherRAGestao(nomeAluno) {
      const alunoSelect = document.getElementById('aluno_gestao');
      const selectedOption = alunoSelect.selectedOptions[0];
      const ra = selectedOption ? selectedOption.getAttribute('data-ra') : '';
      document.getElementById('ra_gestao').value = ra || '';
    }

    /*******************************
     * POST cadastrar ocorrência (gestão) -> grava no SharePoint
     *******************************/
    async function cadastrarOcorrenciaGestao(){
      const alunoSelect = document.getElementById('aluno_gestao');
      const aluno = alunoSelect.value;
      const turmaSelect = document.getElementById('serie_gestao');
      const serie = turmaSelect.value;
      const professor = document.getElementById('professor_gestao').value.trim();
      const disciplina = document.getElementById('disciplina_gestao').value.trim();
      const classificacao = document.getElementById('classificacao_gestao').value;
      const descricao = document.getElementById('descricao_gestao').value.trim();
      const dataRetorno = document.getElementById('dataRetorno_gestao').value || null;
      const ra = document.getElementById('ra_gestao').value;

      if(!aluno || !serie || !professor || !disciplina || !classificacao || !descricao){ 
        alert('Preencha todos os campos obrigatórios.'); 
        return; 
      }
      if(classificacao === 'SUSPENSÃO' && !dataRetorno){ 
        alert('Informe data de retorno para suspensão.'); 
        return; 
      }

      const payload = {
        date: new Date().toISOString().split('T')[0],
        professor: professor,
        studentClass: serie,
        student: aluno,
        ra: ra,
        disciplina: disciplina,
        irregularities: classificacao + (dataRetorno ? (' - retorno: ' + dataRetorno) : ''),
        description: descricao
      };

      const success = await saveToSharePoint(payload, 'gestao');
      
      if(success){
        document.getElementById('successGestao').style.display = 'block';
        setTimeout(()=> document.getElementById('successGestao').style.display = 'none', 2200);
        // limpar
        document.getElementById('serie_gestao').value = '';
        document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
        document.getElementById('ra_gestao').value = '';
        document.getElementById('professor_gestao').value = '';
        document.getElementById('disciplina_gestao').value = '';
        document.getElementById('classificacao_gestao').value = '';
        document.getElementById('descricao_gestao').value = '';
        document.getElementById('suspensionRow_gestao').style.display = 'none';
        carregarHistoricoGestao();
      }
    }

    /*******************************
     * POST registrar ocorrência (professor) -> grava no SharePoint
     *******************************/
    async function registrarOcorrenciaProfessor(){
      const professor = document.getElementById('professor_select').value;
      const turma = document.getElementById('turma_select').value;
      const dataOc = document.getElementById('data_prof').value;
      const descricao = document.getElementById('descricao_prof').value.trim();
      
      if(!professor || !turma || !dataOc || alunosSelecionados.length === 0){ 
        alert('Preencha todos os campos obrigatórios e selecione ao menos um aluno.'); 
        return; 
      }
      
      const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x=>x.value);
      const payload = { 
        date: dataOc, 
        professor: professor, 
        studentClass: turma, 
        student: alunosSelecionados.join(', '), 
        irregularities: irregs.join(', '), 
        description: descricao 
      };
      
      const success = await saveToSharePoint(payload, 'professor');
      
      if(success){
        document.getElementById('successProfessor').style.display = 'block';
        setTimeout(()=> document.getElementById('successProfessor').style.display = 'none', 2200);
        clearProfessorForm();
        carregarHistoricoProfessor();
      }
    }

    // Restante do código permanece similar...
    // [O restante do código JavaScript permanece similar ao original, 
    //  mas removendo as referências ao Google Apps Script]

    // Funções auxiliares e de interface que não dependem do backend específico
    function clearProfessorForm(){
      document.getElementById('professor_select').value=''; 
      document.getElementById('turma_select').value=''; 
      document.getElementById('alunos_selected_input').value=''; 
      document.getElementById('selectedPills').innerHTML=''; 
      document.getElementById('descricao_prof').value=''; 
      alunosSelecionados = []; 
      Array.from(document.querySelectorAll('input[name="irreg"]')).forEach(cb => cb.checked=false); 
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
    }

    function toggleSuspension(area){
      if(area === 'gestao'){ 
        const val = document.getElementById('classificacao_gestao').value; 
        document.getElementById('suspensionRow_gestao').style.display = (val === 'SUSPENSÃO') ? 'flex' : 'none'; 
      }
    }

    // Funções do modal de alunos
    function openStudentsModal(){
      if(!alunosDaTurmaAtual || alunosDaTurmaAtual.length === 0){ 
        alert('Nenhum aluno encontrado para a turma selecionada.'); 
        return; 
      }
      document.getElementById('modalRoot').style.display = 'flex';
      renderStudentList(alunosDaTurmaAtual);
      document.getElementById('studentSearch').value = '';
    }

    function closeStudentsModal(){ 
      document.getElementById('modalRoot').style.display = 'none'; 
    }

    function renderStudentList(list){
      const container = document.getElementById('studentList'); 
      container.innerHTML = '';
      list.forEach(nome => {
        const row = document.createElement('div'); 
        row.style.display='flex';
        row.style.justifyContent='space-between';
        row.style.alignItems='center';
        row.style.padding='8px';
        row.style.borderBottom='1px solid #eee';
        
        const lbl = document.createElement('div'); 
        lbl.textContent = nome;
        
        const cb = document.createElement('input'); 
        cb.type='checkbox'; 
        cb.value = nome; 
        cb.checked = alunosSelecionados.includes(nome);
        cb.onchange = (e) => { 
          if(e.target.checked){ 
            if(!alunosSelecionados.includes(nome)) alunosSelecionados.push(nome); 
          } else {
            alunosSelecionados = alunosSelecionados.filter(x => x !== nome); 
          } 
        };
        
        row.appendChild(lbl); 
        row.appendChild(cb); 
        container.appendChild(row);
      });
    }

    function filterStudentList(){ 
      const q = document.getElementById('studentSearch').value.toLowerCase(); 
      const filtered = alunosDaTurmaAtual.filter(s => s.toLowerCase().includes(q)); 
      renderStudentList(filtered); 
    }

    function confirmStudents(){
      document.getElementById('alunos_selected_input').value = alunosSelecionados.join(', ');
      const pills = document.getElementById('selectedPills'); 
      pills.innerHTML = '';
      alunosSelecionados.forEach(a => { 
        const el = document.createElement('div'); 
        el.className='pill'; 
        el.textContent = a; 
        pills.appendChild(el); 
      });
      closeStudentsModal();
    }

    // Funções de carregamento de dados de demonstração
    async function carregarProfessoresETurmas(){
      // Dados de demonstração
      professores = [
        "PROFESSOR A", "PROFESSOR B", "PROFESSOR C", "PROFESSOR D"
      ];
      
      turmas = [
        "6° ANO A MANHA", "6° ANO B MANHA", "7° ANO A TARDE", "7° ANO B TARDE"
      ];

      const profSel = document.getElementById('professor_select');
      profSel.innerHTML = '<option value="">-- selecione --</option>';
      professores.forEach(p => { 
        const o = document.createElement('option'); 
        o.value = p; 
        o.textContent = p; 
        profSel.appendChild(o); 
      });

      const turmaSel = document.getElementById('turma_select');
      turmaSel.innerHTML = '<option value="">-- selecione --</option>';
      turmas.forEach(t => { 
        const o = document.createElement('option'); 
        o.value = t; 
        o.textContent = t; 
        turmaSel.appendChild(o); 
      });
    }

    async function onTurmaChange(){
      const turma = document.getElementById('turma_select').value;
      if(!turma){ 
        alunosDaTurmaAtual = []; 
        renderStudentList([]); 
        return; 
      }
      
      // Dados de demonstração
      const alunosPorTurma = {
        "6° ANO A MANHA": ["ALUNO A1", "ALUNO A2", "ALUNO A3"],
        "6° ANO B MANHA": ["ALUNO B1", "ALUNO B2", "ALUNO B3"],
        "7° ANO A TARDE": ["ALUNO C1", "ALUNO C2", "ALUNO C3"],
        "7° ANO B TARDE": ["ALUNO D1", "ALUNO D2", "ALUNO D3"]
      };
      
      alunosDaTurmaAtual = alunosPorTurma[turma] || [];
      renderStudentList(alunosDaTurmaAtual);
    }

    // Funções de histórico (simplificadas para demonstração)
    function carregarHistoricoGestao(){
      const container = document.getElementById('historyListGestao');
      container.innerHTML = '<div class="muted">Histórico carregado do SharePoint</div>';
    }

    function carregarHistoricoProfessor(){
      const container = document.getElementById('historyListProfessor');
      container.innerHTML = '<div class="muted">Histórico carregado do SharePoint</div>';
    }

    // Geração de PDF local
    function generatePDFLocal(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Registro de Ocorrência', 14, 20);
        
        const aluno = document.getElementById('aluno_gestao').value || '';
        const turma = document.getElementById('serie_gestao').value || '';
        const prof = document.getElementById('professor_gestao').value || '';
        const desc = document.getElementById('descricao_gestao').value || '';
        
        let y = 36;
        if(aluno){ doc.text(`Aluno: ${aluno}`, 14, y); y+=8; }
        if(turma){ doc.text(`Turma: ${turma}`, 14, y); y+=8; }
        if(prof){ doc.text(`Professor: ${prof}`, 14, y); y+=8; }
        
        doc.text('Descrição:', 14, y); y+=8;
        const split = doc.splitTextToSize(desc || 'Sem descrição', 180);
        doc.text(split, 14, y);
        
        doc.save(`ocorrencia_${Date.now()}.pdf`);
      } catch(err){ 
        console.error('Erro gerar PDF local:', err); 
        alert('Erro ao gerar PDF local (ver console).'); 
      }
    }

  </script>
</body>
</html>
