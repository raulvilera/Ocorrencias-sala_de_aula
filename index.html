<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Registro de Ocorrências Escolares</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary-color: #1a73e8;
      --primary-dark: #0d47a1;
      --secondary-color: #f8f9fa;
      --accent-color: #f1c40f;
      --success-color: #2ecc71;
      --error-color: #e74c3c;
      --border-color: #dadce0;
      --text-color: #202124;
      --light-text: #5f6368;
      --card-bg: #ffffff;
      --footer-bg: #ffffff;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all .25s ease;
      --hover-bg: #f0f5ff;
      --tab-active: #1a73e8; --tab-inactive:#e0e0e0;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    body { background: linear-gradient(135deg,#f5f7fa 0%, #e4edf5 100%); color: var(--text-color); line-height: 1.55; min-height: 100vh; padding-bottom: 64px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    header { position: sticky; top: 0; z-index: 100; background: linear-gradient(135deg, #2ecc71 0%, #3498db 100%); box-shadow: var(--shadow); padding: 14px 0; }
    .header-content { max-width: 1200px; margin:0 auto; display:flex; align-items:center; justify-content: space-between; gap: 16px; padding: 0 20px; }
    .logo { display:flex; align-items:center; gap:14px; }
    .logo-icon { width: 54px; height: 54px; border-radius: 12px; display:grid; place-items:center; color:#fff; background:rgba(255,255,255,.2); backdrop-filter: blur(9px); box-shadow: 0 5px 15px rgba(0,0,0,.1); font-size: 24px; }
    .logo h1 { color:#fff; font-size: 1.45rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,.2); }
    .logo p { color: rgba(255,255,255,.9); font-size:.9rem; }

    main { padding: 26px 0; }
    .dashboard { display:grid; grid-template-columns: 1fr 360px; gap: 24px; margin-bottom: 28px; }

    .card { background: var(--card-bg); border:1px solid var(--border-color); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; transition: var(--transition); }
    .card:hover { transform: translateY(-4px); box-shadow: 0 12px 22px rgba(0,0,0,.12); }
    .card-header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color:#fff; padding: 18px 24px; font-weight: 600; display:flex; align-items:center; gap:10px; }
    .card-body { padding: 24px; }

    .stats-card { background: linear-gradient(135deg, #2ecc71 0%, #3498db 100%); color: #fff; border-radius: 16px; padding: 22px; box-shadow: var(--shadow); }
    .stats-grid { display:grid; grid-template-columns: repeat(4, minmax(130px,1fr)); gap: 16px; margin-top: 14px; }
    .stat-item { background: rgba(255,255,255,.16); border-radius: 12px; padding: 14px; text-align: center; backdrop-filter: blur(8px); transition: var(--transition); }
    .stat-item:hover { transform: translateY(-3px); background: rgba(255,255,255,.22); }
    .stat-value { font-size: 2rem; font-weight: 700; }
    .stat-label { font-size: .95rem; opacity: .9; }

    .tabs { display:flex; background:#fff; border-radius: 10px; overflow:hidden; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
    .tab-button { flex:1; padding: 14px 16px; border:0; background: var(--tab-inactive); color: #555; font-weight:600; cursor:pointer; transition: var(--transition); }
    .tab-button.active { background: var(--tab-active); color:#fff; box-shadow: 0 0 10px rgba(26,115,232,.28); }
    .tab-content { display:none; }
    .tab-content.active { display:block; animation: fade .35s ease; }
    @keyframes fade { from{opacity:0} to{opacity:1} }

    .form-row { display:flex; gap: 20px; margin-bottom: 18px; }
    .form-col { flex: 1; }
    label { display:block; font-weight:600; margin-bottom: 10px; cursor:pointer; }
    .required::after { content:" *"; color: var(--error-color); }
    input, select, textarea { width:100%; padding: 12px 14px; border:2px solid #e1e5eb; border-radius: 10px; font-size: 15px; background:#f8fafc; transition: var(--transition); }
    input:hover, select:hover, textarea:hover { border-color: var(--primary-color); background: var(--hover-bg); box-shadow: 0 0 0 3px rgba(26,115,232,.18); transform: translateY(-1px); }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(26,115,232,.18); background:#fff; transform: translateY(-1px); }
    textarea { min-height: 140px; resize: vertical; }

    .actions, .form-actions { display:flex; gap: 14px; flex-wrap: wrap; margin-top: 8px; }
    .btn { border:0; border-radius: 10px; padding: 14px 20px; font-weight: 700; cursor:pointer; display:inline-flex; align-items:center; gap:10px; box-shadow: 0 5px 12px rgba(0,0,0,.1); transition: var(--transition); }
    .btn:disabled { opacity:.65; cursor:not-allowed; }
    .btn-primary { color:#fff; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); }
    .btn-primary:hover { transform: translateY(-2px); }
    .btn-secondary { background: linear-gradient(135deg,#f8f9fa 0%, #e8eaed 100%); border:1px solid var(--border-color); }

    .registros-table { width:100%; border-collapse: collapse; margin-top: 14px; background:#fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
    .registros-table th { position: sticky; top:0; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color:#fff; padding: 12px; text-align:left; }
    .registros-table td { padding: 12px; border-bottom: 1px solid var(--border-color); }
    .registros-table tr:hover { background: var(--hover-bg); }
    .table-actions { display:flex; justify-content:flex-end; gap: 12px; margin-bottom: 8px; }
    .empty-state { text-align:center; padding: 28px 12px; color: var(--light-text); }

    .integration-status { background:#e8f5e9; color:#1b5e20; padding:14px; border-radius: 10px; display:flex; align-items:center; gap:12px; border:1px solid rgba(46,204,113,.6); margin-bottom: 16px; }
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; background: var(--success-color); display:inline-block; }

    .student-occurrences-card, .class-students-card { display:none; border-radius:16px; padding:22px; color:#fff; box-shadow: var(--shadow); margin-top: 18px; }
    .student-occurrences-card { background: linear-gradient(135deg, #2ecc71 0%, #3498db 100%); }
    .class-students-card { background: linear-gradient(135deg, #3498db 0%, #1a73e8 100%); }
    .student-occurrences-name { font-size: 1.2rem; font-weight: 600; }
    .student-occurrences-count, .class-students-count { font-size: 2.4rem; font-weight: 800; }

    .checkbox-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap: 14px; }
    .checkbox-item { background:#f8fafc; border:1px solid #e1e5eb; border-radius: 10px; padding: 12px; display:flex; align-items:center; gap: 12px; cursor:pointer; transition: var(--transition); }
    .checkbox-item:hover { transform: translateY(-2px); background:#eaf2ff; border-color: var(--primary-color); }
    .checkbox-item input { transform: scale(1.15); }
    .chart-container { position:relative; width: 46px; height: 46px; }
    .chart-value { position:absolute; inset:0; display:grid; place-items:center; font-weight:700; font-size: 12px; }

    footer { background: var(--footer-bg); border-top:1px solid var(--border-color); padding: 22px 0; text-align:center; color: var(--light-text); }

    @media (max-width: 992px) { .dashboard { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .form-row { flex-direction: column; } .tabs { flex-direction: column; } .btn { width:100%; } }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
        <div>
          <h1>Registro de Ocorrências Escolares</h1>
          <p>Sistema integrado ao Google Apps Script</p>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <main>
      <div class="tabs">
        <button class="tab-button active" data-tab="form-tab">Cadastrar Ocorrência</button>
        <button class="tab-button" data-tab="records-tab">Registros</button>
        <button class="tab-button" data-tab="stats-tab">Estatísticas</button>
      </div>

      <!-- FORMULÁRIO -->
      <section id="form-tab" class="tab-content active">
        <div class="dashboard">
          <div>
            <div class="integration-status">
              <i class="fas fa-plug"></i>
              <div>
                <strong>Status de integração:</strong> <span class="status-indicator"></span> Conectado ao Web App
              </div>
            </div>

            <div class="card">
              <div class="card-header"><i class="fas fa-clipboard-list"></i> Informações da Ocorrência</div>
              <div class="card-body">
                <form id="occurrenceForm">
                  <div class="form-row">
                    <div class="form-col">
                      <label for="professor" class="required">Nome do professor</label>
                      <select id="professor" required>
                        <option value="">Selecione seu nome</option>
                      </select>
                    </div>
                    <div class="form-col">
                      <label for="occurrenceDate" class="required">Data da ocorrência</label>
                      <input id="occurrenceDate" type="date" required />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-col">
                      <label for="studentClass" class="required">Turma</label>
                      <select id="studentClass" required>
                        <option value="">Selecione a turma</option>
                      </select>
                    </div>
                    <div class="form-col">
                      <label for="student" class="required">Aluno</label>
                      <select id="student" required disabled>
                        <option value="">Selecione primeiro a turma</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-col">
                      <label>Irregularidades (opcional)</label>
                      <div id="irregularitiesBox" class="checkbox-container">
                        <!-- preenchido via JS a partir das estatísticas/nomes disponíveis -->
                      </div>
                    </div>
                  </div>

                  <label for="description">Descrição detalhada (opcional)</label>
                  <textarea id="description" placeholder="Descreva a ocorrência com mais detalhes..."></textarea>

                  <div class="actions">
                    <button type="button" id="clearBtn" class="btn btn-secondary"><i class="fas fa-eraser"></i> Limpar</button>
                    <button type="submit" id="submitBtn" class="btn btn-primary"><i class="fas fa-save"></i> Cadastrar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <aside>
            <div class="stats-card">
              <h3><i class="fas fa-chart-line"></i> Estatísticas Gerais</h3>
              <div class="stats-grid">
                <div class="stat-item"><div id="totalOccurrences" class="stat-value">0</div><div class="stat-label">Ocorrências</div></div>
                <div class="stat-item"><div id="totalStudents" class="stat-value">0</div><div class="stat-label">Alunos</div></div>
                <div class="stat-item"><div id="totalTeachers" class="stat-value">0</div><div class="stat-label">Professores</div></div>
                <div class="stat-item"><div id="totalClasses" class="stat-value">0</div><div class="stat-label">Turmas</div></div>
              </div>
              <div style="height:200px;margin-top:12px"><canvas id="studentsPeriodChart"></canvas></div>
            </div>

            <div id="studentOccurrencesCard" class="student-occurrences-card">
              <div class="student-occurrences-name" id="studentOccurrencesName">—</div>
              <div class="student-occurrences-count" id="studentOccurrencesCount">0</div>
              <div>Ocorrências registradas</div>
            </div>

            <div id="classStudentsCard" class="class-students-card">
              <div>Alunos na turma <span id="selectedClassPeriod"></span></div>
              <div class="class-students-count" id="classStudentsCount">0</div>
            </div>
          </aside>
        </div>
      </section>

      <!-- REGISTROS -->
      <section id="records-tab" class="tab-content">
        <div class="card">
          <div class="card-header"><i class="fas fa-table"></i> Registros de Ocorrências</div>
          <div class="card-body">
            <div class="table-actions">
              <button id="exportBtn" class="btn btn-secondary"><i class="fas fa-file-excel"></i> Exportar Excel</button>
            </div>
            <div id="noRecordsMessage" class="empty-state" style="display:none">
              <i class="fas fa-clipboard-list" style="font-size:40px; color:#ccc"></i>
              <p>Nenhum registro encontrado.</p>
            </div>
            <table id="registrosTable" class="registros-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Professor</th>
                  <th>Turma</th>
                  <th>Aluno</th>
                  <th>Irregularidades</th>
                  <th>Descrição</th>
                </tr>
              </thead>
              <tbody id="registrosTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ESTATÍSTICAS -->
      <section id="stats-tab" class="tab-content">
        <div class="dashboard">
          <div>
            <div class="card">
              <div class="card-header"><i class="fas fa-chart-bar"></i> Resumo Geral</div>
              <div class="card-body">
                <div class="stats-grid">
                  <div class="stat-item"><div id="totalOccurrencesStats" class="stat-value">0</div><div class="stat-label">Total de Ocorrências</div></div>
                  <div class="stat-item"><div id="mostFrequentIrregularity" class="stat-value">—</div><div class="stat-label">Irregularidade Mais Comum</div></div>
                  <div class="stat-item"><div id="mostAffectedClass" class="stat-value">—</div><div class="stat-label">Turma Mais Afetada</div></div>
                </div>
              </div>
            </div>
          </div>
          <aside>
            <div class="card">
              <div class="card-header"><i class="fas fa-chart-column"></i> Ocorrências por Turma</div>
              <div class="card-body"><div style="height:220px"><canvas id="classOccurrencesChart"></canvas></div></div>
            </div>
          </aside>
        </div>
        <div class="card">
          <div class="card-header"><i class="fas fa-chart-pie"></i> Distribuição de Irregularidades</div>
          <div class="card-body"><div style="height:240px"><canvas id="irregularitiesChart"></canvas></div></div>
        </div>
      </section>
    </main>
  </div>

  <footer>
    <div>SGE © 2025</div>
  </footer>

  <!-- ========= JS ========= -->
  <script>
    // ==========================
    // CONFIGURAÇÃO
    // ==========================
    const SCRIPT_URL = (document.currentScript.dataset.endpoint) || "https://script.google.com/macros/s/AKfycbyLXdbAEa1KLC8Qye6IZMEXhWIkAjhrtXZ8MxGo8XBkXKONwdqDqxDCR4bswl-Vtl5z/exec"; // substitua pela URL do Web App

    // ALIASES (espelham o back-end):
    // case "getClasses"                -> handleGetClasses()
    // case "getStudents"               -> handleGetStudentsByClass(e)
    // case "getOccurrences"            -> handleGetOccurrences()
    // case "getSchoolStats"            -> handleGetStudentPeriodStats()
    // case "getIrregularitiesStats"    -> handleGetIrregularityStats()

    const api = {
      getClasses: () => fetchJson(`${'https://script.google.com/macros/s/AKfycbyLXdbAEa1KLC8Qye6IZMEXhWIkAjhrtXZ8MxGo8XBkXKONwdqDqxDCR4bswl-Vtl5z/exec'}?action=getClasses`),
      getStudents: (turma) => fetchJson(`${'https://script.google.com/macros/s/AKfycbyLXdbAEa1KLC8Qye6IZMEXhWIkAjhrtXZ8MxGo8XBkXKONwdqDqxDCR4bswl-Vtl5z/exec'}?action=getStudents&turma=${encodeURIComponent(turma)}`),
      getOccurrences: () => fetchJson(`${'https://script.google.com/macros/s/AKfycbyLXdbAEa1KLC8Qye6IZMEXhWIkAjhrtXZ8MxGo8XBkXKONwdqDqxDCR4bswl-Vtl5z/exec'}?action=getOccurrences`),
      getSchoolStats: () => fetchJson(`${'https://script.google.com/macros/s/AKfycbyLXdbAEa1KLC8Qye6IZMEXhWIkAjhrtXZ8MxGo8XBkXKONwdqDqxDCR4bswl-Vtl5z/exec'}?action=getSchoolStats`),
      getIrregularitiesStats: () => fetchJson(`${'https://script.google.com/macros/s/AKfycbyLXdbAEa1KLC8Qye6IZMEXhWIkAjhrtXZ8MxGo8XBkXKONwdqDqxDCR4bswl-Vtl5z/exec'}?action=getIrregularitiesStats`),
      registerOccurrence: (payload) => fetchJson('https://script.google.com/macros/s/AKfycbyLXdbAEa1KLC8Qye6IZMEXhWIkAjhrtXZ8MxGo8XBkXKONwdqDqxDCR4bswl-Vtl5z/exec', { method:'POST', body: JSON.stringify({ action:'registerOccurrence', ...payload }) })
    };

    async function fetchJson(url, options={}) {
      const res = await fetch(url, { headers: { 'Content-Type':'application/json' }, ...options });
      return res.json();
    }

    // ==========================
    // DOM HOOKS
    // ==========================
    const els = {
      tabs: Array.from(document.querySelectorAll('.tab-button')),
      tabContents: Array.from(document.querySelectorAll('.tab-content')),
      professor: document.getElementById('professor'),
      occurrenceDate: document.getElementById('occurrenceDate'),
      classSelect: document.getElementById('studentClass'),
      studentSelect: document.getElementById('student'),
      irregularitiesBox: document.getElementById('irregularitiesBox'),
      description: document.getElementById('description'),
      form: document.getElementById('occurrenceForm'),
      clearBtn: document.getElementById('clearBtn'),
      exportBtn: document.getElementById('exportBtn'),
      registrosTableBody: document.getElementById('registrosTableBody'),
      noRecordsMessage: document.getElementById('noRecordsMessage'),
      // KPI
      totalOccurrences: document.getElementById('totalOccurrences'),
      totalStudents: document.getElementById('totalStudents'),
      totalTeachers: document.getElementById('totalTeachers'),
      totalClasses: document.getElementById('totalClasses'),
      // Cards
      classStudentsCard: document.getElementById('classStudentsCard'),
      classStudentsCount: document.getElementById('classStudentsCount'),
      selectedClassPeriod: document.getElementById('selectedClassPeriod'),
      studentOccurrencesCard: document.getElementById('studentOccurrencesCard'),
      studentOccurrencesName: document.getElementById('studentOccurrencesName'),
      studentOccurrencesCount: document.getElementById('studentOccurrencesCount'),
      // Charts
      studentsPeriodChartCanvas: document.getElementById('studentsPeriodChart'),
      irregularitiesChartCanvas: document.getElementById('irregularitiesChart'),
      classOccurrencesChartCanvas: document.getElementById('classOccurrencesChart'),
    };

    let charts = { studentsPeriod:null, irregularities:null, classOccurrences:null };

    // ==========================
    // TABS
    // ==========================
    els.tabs.forEach(btn => btn.addEventListener('click', () => {
      els.tabs.forEach(b => b.classList.remove('active'));
      els.tabContents.forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    }));

    // ==========================
    // INICIALIZAÇÃO
    // ==========================
    (async function init(){
      // Data inicial do dia
      els.occurrenceDate.valueAsDate = new Date();

      await Promise.all([
        hydrateClasses(),
        hydrateSchoolStats(),
        hydrateIrregularitiesUI(),
        hydrateOccurrences()
      ]);

      // Preencher dropdown de professores a partir dos registros existentes (fallback sem endpoint dedicado)
      populateTeachersFromOccurrences();
    })();

    // ==========================
    // HYDRATE UI
    // ==========================
    async function hydrateClasses(){
      const data = await api.getClasses();
      if (data?.status === 'success' && Array.isArray(data.classes)) {
        els.classSelect.innerHTML = '<option value="">Selecione a turma</option>' + data.classes.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        els.totalClasses.textContent = data.classes.length;
      }
    }

    async function hydrateSchoolStats(){
      const data = await api.getSchoolStats();
      if (data?.status === 'success') {
        const { totalStudents=0, morningStudents=0, afternoonStudents=0, nightStudents=0 } = data;
        els.totalStudents.textContent = totalStudents;
        // Gráfico de períodos
        renderStudentsPeriodChart([morningStudents,afternoonStudents,nightStudents]);
      }
    }

    async function hydrateIrregularitiesUI(){
      const data = await api.getIrregularitiesStats();
      const irregularities = (data?.status === 'success') ? data.irregularities : {};
      const names = Object.keys(irregularities).length ? Object.keys(irregularities) : [
        'Não fez a lição','Não trouxe material','Fora do lugar durante a aula','Chegou atrasado','Conversando durante a aula','Uso de celular','Desrespeito ao professor','Desrespeito aos colegas','Dormindo em sala','Outros'
      ];
      els.irregularitiesBox.innerHTML = names.map((name, idx)=>
        `<label class="checkbox-item">
           <div class="chart-container">
             <canvas class="donut-chart" width="46" height="46" data-irregularity="${escapeHtml(name)}"></canvas>
             <span class="chart-value">${irregularities[name] ?? 0}</span>
           </div>
           <input type="checkbox" value="${escapeHtml(name)}" />
           <span>${escapeHtml(name)}</span>
         </label>`
      ).join('');
      // Render donuts (somente UI, não estatístico global)
      renderInlineDonuts();
      // Gráfico geral de irregularidades
      renderIrregularitiesChart(irregularities);
    }

    async function hydrateOccurrences(){
      const data = await api.getOccurrences();
      if (!(data?.status === 'success' && Array.isArray(data.occurrences))) {
        els.noRecordsMessage.style.display = 'block';
        return;
      }
      const occs = data.occurrences;
      els.totalOccurrences.textContent = occs.length;
      document.getElementById('totalOccurrencesStats').textContent = occs.length;

      // preencher tabela
      els.registrosTableBody.innerHTML = occs.map(o => `
        <tr>
          <td>${formatDateBR(o.dataOcorrencia)}</td>
          <td>${escapeHtml(o.professor)}</td>
          <td>${escapeHtml(o.turma)}</td>
          <td>${escapeHtml(o.aluno)}</td>
          <td>${escapeHtml(o.irregularidades)}</td>
          <td>${escapeHtml(o.descricao)}</td>
        </tr>`).join('');
      els.noRecordsMessage.style.display = occs.length ? 'none' : 'block';

      // KPI: turma mais afetada & irregularidade mais comum
      const byClass = groupCount(occs, o=>o.turma);
      const byIrreg = countIrregularities(occs);
      const mostClass = topKey(byClass);
      const mostIrreg = topKey(byIrreg);
      document.getElementById('mostAffectedClass').textContent = mostClass || '—';
      document.getElementById('mostFrequentIrregularity').textContent = mostIrreg || '—';

      renderClassOccurrencesChart(byClass);
    }

    function populateTeachersFromOccurrences(){
      const rows = Array.from(els.registrosTableBody.querySelectorAll('tr'));
      const set = new Set(rows.map(r => r.children[1]?.textContent).filter(Boolean));
      if (!set.size) return;
      const current = els.professor.value;
      els.professor.innerHTML = '<option value="">Selecione seu nome</option>' + Array.from(set).sort().map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
      if (current) els.professor.value = current;
      els.totalTeachers.textContent = set.size;
    }

    // ==========================
    // EVENTOS DE UI
    // ==========================
    els.classSelect.addEventListener('change', async () => {
      const turma = els.classSelect.value;
      if (!turma) return;
      const data = await api.getStudents(turma);
      if (data?.status === 'success') {
        const students = data.students || [];
        els.studentSelect.disabled = false;
        els.studentSelect.innerHTML = '<option value="">Selecione o aluno</option>' + students.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
        els.classStudentsCard.style.display = 'block';
        els.classStudentsCount.textContent = data.total ?? students.length;
        els.selectedClassPeriod.textContent = turma;
      }
    });

    els.studentSelect.addEventListener('change', async () => {
      const name = els.studentSelect.value;
      if (!name) return;
      const data = await api.getOccurrences();
      const occs = (data?.status==='success' ? data.occurrences : []).filter(o => o.aluno === name);
      const count = occs.length;
      els.studentOccurrencesCard.style.display = 'block';
      els.studentOccurrencesName.textContent = name;
      els.studentOccurrencesCount.textContent = count;
    });

    els.clearBtn.addEventListener('click', () => {
      els.form.reset();
      els.studentSelect.disabled = true;
      els.studentOccurrencesCard.style.display = 'none';
    });

    els.form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = collectForm();
      if (!payload) return;
      const result = await api.registerOccurrence(payload);
      if (result?.status === 'success') {
        alert('Ocorrência registrada com sucesso!');
        els.form.reset();
        els.studentSelect.disabled = true;
        await Promise.all([ hydrateOccurrences(), hydrateIrregularitiesUI() ]);
      } else {
        alert('Erro: ' + (result?.message || 'Falha ao cadastrar.'));
      }
    });

    els.exportBtn.addEventListener('click', () => exportTableToExcel());

    // ==========================
    // HELPERS
    // ==========================
    function collectForm(){
      const professor = els.professor.value.trim();
      const turma = els.classSelect.value.trim();
      const aluno = els.studentSelect.value.trim();
      const dataOcorrencia = els.occurrenceDate.value;
      const descricao = els.description.value.trim();
      const irregularidades = Array.from(els.irregularitiesBox.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
      if (!professor || !turma || !aluno || !dataOcorrencia) {
        alert('Preencha todos os campos obrigatórios.');
        return null;
      }
      return { professor, turma, aluno, dataOcorrencia, descricao, irregularidades };
    }

    function renderStudentsPeriodChart(vals){
      const ctx = els.studentsPeriodChartCanvas.getContext('2d');
      if (charts.studentsPeriod) charts.studentsPeriod.destroy();
      charts.studentsPeriod = new Chart(ctx, { type:'bar', data:{ labels:['Manhã','Tarde','Noite'], datasets:[{ data: vals }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
    }

    function renderIrregularitiesChart(map){
      const labels = Object.keys(map);
      const values = Object.values(map);
      const ctx = els.irregularitiesChartCanvas.getContext('2d');
      if (charts.irregularities) charts.irregularities.destroy();
      charts.irregularities = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data: values }] }, options:{ responsive:true } });
    }

    function renderClassOccurrencesChart(byClass){
      const labels = Object.keys(byClass);
      const values = Object.values(byClass);
      const ctx = els.classOccurrencesChartCanvas.getContext('2d');
      if (charts.classOccurrences) charts.classOccurrences.destroy();
      charts.classOccurrences = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data: values }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ autoSkip: false } } } } });
    }

    function renderInlineDonuts(){
      document.querySelectorAll('.donut-chart').forEach(canvas => {
        const ctx = canvas.getContext('2d');
        const valueEl = canvas.parentElement.querySelector('.chart-value');
        const val = parseInt(valueEl?.textContent || '0', 10);
        // desenhar donut simples
        const r = canvas.width/2; const c = { x:r, y:r }; const start = -Math.PI/2; const frac = Math.max(0, Math.min(1, val / 10));
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // trilha
        ctx.beginPath(); ctx.arc(c.x,c.y,r-4,0,2*Math.PI); ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 6; ctx.stroke();
        // progresso
        ctx.beginPath(); ctx.arc(c.x,c.y,r-4,start,start + 2*Math.PI*frac); ctx.strokeStyle = '#1a73e8'; ctx.lineWidth = 6; ctx.stroke();
      });
    }

    function exportTableToExcel(){
      const wb = XLSX.utils.book_new();
      const data = [['Data','Professor','Turma','Aluno','Irregularidades','Descrição']];
      Array.from(els.registrosTableBody.querySelectorAll('tr')).forEach(tr => {
        const row = Array.from(tr.children).map(td => td.textContent);
        if (row.length) data.push(row);
      });
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, 'Ocorrências');
      XLSX.writeFile(wb, `ocorrencias_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function groupCount(arr, keyFn){
      const map = {};
      for (const item of arr) { const k = keyFn(item) || '—'; map[k] = (map[k]||0) + 1; }
      return map;
    }

    function countIrregularities(occs){
      const map = {};
      for (const o of occs) {
        const items = (o.irregularidades || '').split(',').map(s=>s.trim()).filter(Boolean);
        for (const it of items) map[it] = (map[it]||0) + 1;
      }
      return map;
    }

    function topKey(obj){
      let top = null, max = -Infinity; for (const [k,v] of Object.entries(obj)) { if (v>max) { max=v; top=k; } } return top;
    }

    function formatDateBR(input){
      const d = new Date(input);
      if (isNaN(d)) return input || '';
      return d.toLocaleDateString('pt-BR');
    }

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"]g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }
  </script>
</body>
</html>
