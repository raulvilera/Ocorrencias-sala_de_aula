<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025 - Cadastro de Ocorr√™ncias</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      min-height: 100vh;
    }

    /* LOGIN */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }

    .login-card h1 {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .login-card p {
      text-align: center;
      color: #64748b;
      margin-bottom: 24px;
    }

    /* FORM ELEMENTS */
    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #1e293b;
    }

    label.white {
      color: white;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input:disabled, select:disabled {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-primary:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      width: auto;
      padding: 10px 20px;
    }

    .btn-outline:hover {
      background: rgba(255,255,255,0.1);
    }

    .demo-info {
      margin-top: 24px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      text-align: center;
      font-size: 13px;
      color: #64748b;
    }

    .demo-info strong {
      display: block;
      color: #1e293b;
    }

    /* APP */
    .app-container {
      min-height: 100vh;
      background: #f1f5f9;
    }

    .header {
      background: linear-gradient(90deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 700;
    }

    .header-subtitle {
      font-size: 13px;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-email {
      font-size: 14px;
      font-weight: 500;
    }

    .main-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    .panel-card {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .panel-title {
      color: white;
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      text-align: center;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 640px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* RADIO GROUP */
    .radio-group {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .radio-option {
      flex: 1;
      padding: 16px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .radio-option:hover {
      border-color: #3b82f6;
    }

    .radio-option.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    /* CHECKBOX GROUP */
    .checkbox-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.9);
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkbox-item:hover {
      background: white;
    }

    .checkbox-item input {
      width: 20px;
      height: 20px;
      accent-color: #3b82f6;
    }

    .checkbox-item span {
      font-weight: 500;
      color: #1e293b;
    }

    /* LOADING */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e2e8f0;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-container">
    <div class="login-card">
      <h1>2025 - Cadastro de Ocorr√™ncias</h1>
      <p>Entre com sua conta para acessar o sistema</p>
      <form id="loginForm">
        <div class="form-group">
          <label>E-mail</label>
          <input type="email" id="loginEmail" placeholder="Digite seu e-mail" required>
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input type="password" id="loginPassword" placeholder="Digite sua senha" required>
        </div>
        <button type="submit" class="btn btn-primary">Entrar</button>
        <div class="demo-info">
          <p>Contas de demonstra√ß√£o:</p>
          <strong>gestao@escola.com / gestao123</strong>
          <strong>professor@escola.com / prof123</strong>
        </div>
      </form>
    </div>
  </div>

  <!-- APP SCREEN -->
  <div id="appScreen" class="app-container hidden">
    <header class="header">
      <div class="header-content">
        <div>
          <h1>2025 - Cadastro de Ocorr√™ncias</h1>
          <p class="header-subtitle">Sistema de registro escolar</p>
        </div>
        <div class="header-right">
          <span class="user-email" id="userEmailDisplay"></span>
          <button class="btn btn-outline" onclick="logout()">Sair</button>
        </div>
      </div>
    </header>
    
    <main class="main-content">
      <div id="loadingIndicator" class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 16px; color: #64748b;">Carregando dados...</p>
      </div>

      <!-- PAINEL GEST√ÉO -->
      <div id="managementPanel" class="panel-card hidden">
        <h2 class="panel-title">üìã Registro de Ocorr√™ncia / Suspens√£o</h2>
        <form id="managementForm">
          <div class="form-group">
            <label class="white">CLASSIFICA√á√ÉO</label>
            <div class="radio-group">
              <div class="radio-option selected" data-value="OCORR√äNCIA" onclick="selectClassification(this)">OCORR√äNCIA</div>
              <div class="radio-option" data-value="SUSPENS√ÉO" onclick="selectClassification(this)">SUSPENS√ÉO</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="white">TURMA</label>
              <select id="mgmtClass" onchange="loadStudentsForClass('mgmt')" required>
                <option value="">Selecione a turma</option>
              </select>
            </div>
            <div class="form-group">
              <label class="white">ALUNO</label>
              <select id="mgmtStudent" onchange="updateRA('mgmt')" disabled required>
                <option value="">Selecione o aluno</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="white">PROFESSOR</label>
              <select id="mgmtTeacher" required>
                <option value="">Selecione o professor</option>
              </select>
            </div>
            <div class="form-group">
              <label class="white">DISCIPLINA</label>
              <input type="text" id="mgmtDisciplina" placeholder="Digite a disciplina" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="white">RA</label>
              <input type="text" id="mgmtRA" placeholder="RA do aluno" readonly>
            </div>
            <div class="form-group" id="dataRetornoGroup" style="display: none;">
              <label class="white">DATA DE RETORNO</label>
              <input type="date" id="mgmtDataRetorno">
            </div>
          </div>

          <div class="form-group">
            <label class="white">DESCRI√á√ÉO</label>
            <textarea id="mgmtDescricao" placeholder="Descreva a ocorr√™ncia detalhadamente..." required></textarea>
          </div>

          <button type="submit" class="btn btn-primary" id="mgmtSubmitBtn">REGISTRAR</button>
        </form>
      </div>

      <!-- PAINEL PROFESSOR -->
      <div id="teacherPanel" class="panel-card hidden">
        <h2 class="panel-title">üë®‚Äçüè´ Registro de Irregularidade</h2>
        <form id="teacherForm">
          <div class="form-row">
            <div class="form-group">
              <label class="white">PROFESSOR</label>
              <select id="tchrTeacher" required>
                <option value="">Selecione seu nome</option>
              </select>
            </div>
            <div class="form-group">
              <label class="white">DATA DA OCORR√äNCIA</label>
              <input type="date" id="tchrData" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="white">TURMA</label>
              <select id="tchrClass" onchange="loadStudentsForClass('tchr')" required>
                <option value="">Selecione a turma</option>
              </select>
            </div>
            <div class="form-group">
              <label class="white">ALUNO</label>
              <select id="tchrStudent" onchange="updateRA('tchr')" disabled required>
                <option value="">Selecione o aluno</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="white">TIPO DE IRREGULARIDADE</label>
            <div class="checkbox-grid" id="irregularitiesGrid">
              <label class="checkbox-item"><input type="checkbox" value="N√£o trouxe material"> <span>N√£o trouxe material</span></label>
              <label class="checkbox-item"><input type="checkbox" value="N√£o fez atividade/li√ß√£o de casa"> <span>N√£o fez atividade/li√ß√£o</span></label>
              <label class="checkbox-item"><input type="checkbox" value="Atrapalhou a aula"> <span>Atrapalhou a aula</span></label>
              <label class="checkbox-item"><input type="checkbox" value="Desrespeitou o professor"> <span>Desrespeitou o professor</span></label>
              <label class="checkbox-item"><input type="checkbox" value="Desrespeitou o colega"> <span>Desrespeitou o colega</span></label>
              <label class="checkbox-item"><input type="checkbox" value="Usou celular sem permiss√£o"> <span>Usou celular sem permiss√£o</span></label>
            </div>
          </div>

          <div class="form-group">
            <label class="white">DESCRI√á√ÉO ADICIONAL</label>
            <textarea id="tchrDescricao" placeholder="Detalhes adicionais sobre a irregularidade..."></textarea>
          </div>

          <button type="submit" class="btn btn-primary" id="tchrSubmitBtn">REGISTRAR</button>
        </form>
      </div>
    </main>
  </div>

  <script>
    // ===================== CONFIGURA√á√ÉO =====================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzB4JA_PUPVTBxx2ClY56N3_0jqhaZoCZ-cDLlPqyCDpVDlr1s9zSS-MWPkGuHq-D2z/exec';
    
    // ===================== ESTADO GLOBAL =====================
    let currentUser = null;
    let classesData = [];
    let teachersData = [];
    let studentsData = { mgmt: [], tchr: [] };
    let selectedClassification = 'OCORR√äNCIA';

    // ===================== FUN√á√ïES DE UI =====================
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 4000);
    }

    function selectClassification(el) {
      document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
      el.classList.add('selected');
      selectedClassification = el.dataset.value;
      document.getElementById('dataRetornoGroup').style.display = 
        selectedClassification === 'SUSPENS√ÉO' ? 'block' : 'none';
    }

    // ===================== API CALLS =====================
    async function fetchClasses() {
      try {
        const response = await fetch(`${SCRIPT_URL}?endpoint=classes`);
        const data = await response.json();
        return data.status === 'success' ? data.classes : [];
      } catch (error) {
        console.error('Erro ao buscar turmas:', error);
        return [];
      }
    }

    async function fetchTeachers() {
      try {
        const response = await fetch(`${SCRIPT_URL}?endpoint=teachers`);
        const data = await response.json();
        return data.status === 'success' ? data.teachers : [];
      } catch (error) {
        console.error('Erro ao buscar professores:', error);
        return [];
      }
    }

    async function fetchStudents(turma) {
      try {
        const response = await fetch(`${SCRIPT_URL}?endpoint=students&turma=${encodeURIComponent(turma)}`);
        const data = await response.json();
        return data.status === 'success' ? data.students : [];
      } catch (error) {
        console.error('Erro ao buscar alunos:', error);
        return [];
      }
    }

    async function postOccurrence(payload) {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      return await response.json();
    }

    // ===================== POPULAR SELECTS =====================
    function populateSelect(selectId, items, placeholder = 'Selecione') {
      const select = document.getElementById(selectId);
      select.innerHTML = `<option value="">${placeholder}</option>`;
      items.forEach(item => {
        const option = document.createElement('option');
        if (typeof item === 'object') {
          option.value = item.nome;
          option.textContent = `${item.nome}${item.ra ? ` ‚Äî RA: ${item.ra}` : ''}`;
        } else {
          option.value = item;
          option.textContent = item;
        }
        select.appendChild(option);
      });
    }

    async function loadStudentsForClass(prefix) {
      const classSelect = document.getElementById(`${prefix}Class`);
      const studentSelect = document.getElementById(`${prefix}Student`);
      const turma = classSelect.value;

      if (!turma) {
        studentSelect.disabled = true;
        studentSelect.innerHTML = '<option value="">Selecione o aluno</option>';
        studentsData[prefix] = [];
        return;
      }

      studentSelect.innerHTML = '<option value="">Carregando...</option>';
      studentsData[prefix] = await fetchStudents(turma);
      populateSelect(`${prefix}Student`, studentsData[prefix], 'Selecione o aluno');
      studentSelect.disabled = false;
    }

    function updateRA(prefix) {
      const studentSelect = document.getElementById(`${prefix}Student`);
      const raInput = document.getElementById(`${prefix}RA`);
      const selectedName = studentSelect.value;
      const student = studentsData[prefix].find(s => s.nome === selectedName);
      if (raInput) raInput.value = student?.ra || '';
    }

    // ===================== LOGIN =====================
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (email === 'gestao@escola.com' && password === 'gestao123') {
        currentUser = { email, role: 'gestao' };
      } else if (email === 'professor@escola.com' && password === 'prof123') {
        currentUser = { email, role: 'professor' };
      } else {
        showToast('E-mail ou senha incorretos!', 'error');
        return;
      }

      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('appScreen').classList.remove('hidden');
      document.getElementById('userEmailDisplay').textContent = currentUser.email;
      loadAppData();
    });

    function logout() {
      currentUser = null;
      document.getElementById('appScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('loginForm').reset();
    }

    // ===================== CARREGAR DADOS DO APP =====================
    async function loadAppData() {
      document.getElementById('loadingIndicator').classList.remove('hidden');
      document.getElementById('managementPanel').classList.add('hidden');
      document.getElementById('teacherPanel').classList.add('hidden');

      try {
        [classesData, teachersData] = await Promise.all([fetchClasses(), fetchTeachers()]);

        // Popular selects
        populateSelect('mgmtClass', classesData, 'Selecione a turma');
        populateSelect('mgmtTeacher', teachersData, 'Selecione o professor');
        populateSelect('tchrClass', classesData, 'Selecione a turma');
        populateSelect('tchrTeacher', teachersData, 'Selecione seu nome');

        // Definir data de hoje no campo de data do professor
        document.getElementById('tchrData').valueAsDate = new Date();

      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showToast('Erro ao carregar dados!', 'error');
      }

      document.getElementById('loadingIndicator').classList.add('hidden');
      
      if (currentUser.role === 'gestao') {
        document.getElementById('managementPanel').classList.remove('hidden');
      } else {
        document.getElementById('teacherPanel').classList.remove('hidden');
      }
    }

    // ===================== SUBMIT GEST√ÉO =====================
    document.getElementById('managementForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = document.getElementById('mgmtSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'Enviando...';

      try {
        const now = new Date();
        const dataRegistro = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR');
        const dataFormatada = now.toLocaleDateString('pt-BR');
        const dataRetorno = selectedClassification === 'SUSPENS√ÉO' 
          ? document.getElementById('mgmtDataRetorno').value 
          : '';

        const payload = {
          sheet: 'BANCODEALUNOS',
          data: [
            document.getElementById('mgmtStudent').value,     // A - NOME
            document.getElementById('mgmtClass').value,       // B - S√âRIE
            document.getElementById('mgmtTeacher').value,     // C - PROFESSOR
            document.getElementById('mgmtRA').value || '',    // D - RA
            document.getElementById('mgmtDisciplina').value,  // E - DISCIPLINA
            dataRegistro,                                      // F - DATA DO REGISTRO
            document.getElementById('mgmtDescricao').value.trim(), // G - DESCRI√á√ÉO
            '',                                                // H - URL (preenchido pelo Apps Script)
            dataRetorno                                        // I - DATA DE RETORNO
          ],
          templateId: '1dHwyN8mlb_4bltEksnoc3Yx5wUcDNgAkzqsluLPYePS',
          placeholders: {
            OCORRENCIA: selectedClassification === 'OCORR√äNCIA' ? 'X' : '',
            SUSPENSAO: selectedClassification === 'SUSPENS√ÉO' ? 'X' : '',
            NOME: document.getElementById('mgmtStudent').value,
            SERIE: document.getElementById('mgmtClass').value,
            RETORNO: dataRetorno,
            DESCRICAO: document.getElementById('mgmtDescricao').value.trim(),
            DATA: dataFormatada
          }
        };

        console.log('=== PAYLOAD GEST√ÉO ===', payload);
        const result = await postOccurrence(payload);

        if (result.status === 'success') {
          showToast('Registro realizado com sucesso!', 'success');
          document.getElementById('managementForm').reset();
          document.getElementById('mgmtStudent').disabled = true;
          selectClassification(document.querySelector('.radio-option[data-value="OCORR√äNCIA"]'));
        } else {
          showToast(result.message || 'Erro ao registrar!', 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao enviar dados!', 'error');
      }

      btn.disabled = false;
      btn.textContent = 'REGISTRAR';
    });

    // ===================== SUBMIT PROFESSOR =====================
    document.getElementById('teacherForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = document.getElementById('tchrSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'Enviando...';

      try {
        const checkboxes = document.querySelectorAll('#irregularitiesGrid input:checked');
        const irregularities = Array.from(checkboxes).map(cb => cb.value).join('; ');

        const payload = {
          sheet: 'OCORRENCIASDOSPROFESSORES',
          date: document.getElementById('tchrData').value,
          professor: document.getElementById('tchrTeacher').value,
          studentClass: document.getElementById('tchrClass').value,
          student: document.getElementById('tchrStudent').value,
          ra: studentsData.tchr.find(s => s.nome === document.getElementById('tchrStudent').value)?.ra || '',
          disciplina: '',
          irregularities: irregularities,
          description: document.getElementById('tchrDescricao').value.trim()
        };

        console.log('=== PAYLOAD PROFESSOR ===', payload);
        const result = await postOccurrence(payload);

        if (result.status === 'success') {
          showToast('Irregularidade registrada com sucesso!', 'success');
          document.getElementById('teacherForm').reset();
          document.getElementById('tchrStudent').disabled = true;
          document.getElementById('tchrData').valueAsDate = new Date();
        } else {
          showToast(result.message || 'Erro ao registrar!', 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao enviar dados!', 'error');
      }

      btn.disabled = false;
      btn.textContent = 'REGISTRAR';
    });
  </script>
</body>
</html>
